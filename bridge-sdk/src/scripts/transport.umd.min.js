var e,t;e=window,t=function(e){return function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(t,s){t.exports=e},,function(e,t,s){s.r(t),s.d(t,"TransportEventBus",(function(){return xe})),s.d(t,"MessageHandlerConfig",(function(){return d})),s.d(t,"Message",(function(){return g})),s.d(t,"MonitorChannel",(function(){return n})),s.d(t,"MonitorType",(function(){return i})),s.d(t,"MonitorObject",(function(){return r})),s.d(t,"APIRequest",(function(){return J})),s.d(t,"APIResponse",(function(){return Q})),s.d(t,"MutationRequestWrapper",(function(){return Se})),s.d(t,"BaseStoreState",(function(){return ye})),s.d(t,"StoreStateChange",(function(){return ve})),s.d(t,"StoreStateMutation",(function(){return _e})),s.d(t,"StoreMessageArgs",(function(){return Me})),s.d(t,"StoreStreamImpl",(function(){return we})),s.d(t,"MutateStreamImpl",(function(){return Oe})),s.d(t,"ORG_ID",(function(){return a})),s.d(t,"ORGS",(function(){return c})),s.d(t,"MessageType",(function(){return h})),s.d(t,"EventBus",(function(){return u})),s.d(t,"TransactionType",(function(){return l})),s.d(t,"BridgeConnectionAdvancedConfig",(function(){return Te})),s.d(t,"ConnectionState",(function(){return q})),s.d(t,"StompClient",(function(){return W})),s.d(t,"StompParser",(function(){return b})),s.d(t,"BrokerConnector",(function(){return X})),s.d(t,"StompValidator",(function(){return z})),s.d(t,"BrokerConnectorChannel",(function(){return ee})),s.d(t,"StompSession",(function(){return te})),s.d(t,"StompConfig",(function(){return se})),s.d(t,"ProxyType",(function(){return ae}));class n{}var i;n.stream="#messagebus-monitor",function(e){e.MonitorCloseChannel="Channel_Closed",e.MonitorGalacticUnsubscribe="Galactic_Channel_Unsubscribed",e.MonitorCompleteChannel="Channel_Completed",e.MonitorDestroyChannel="Channel_Destroyed",e.MonitorObserverJoinedChannel="Observer_Joined_Channel",e.MonitorObserverSubscribedChannel="Observer_Unsubscribed_From_Channel ",e.MonitorObserverUnsubscribedChannel="Observer_Unsubscribed",e.MonitorObserverLeftChannel="Observer_Left_Channel",e.MonitorNewChannel="New_Channel_Created",e.MonitorNewGalacticChannel="New_Galactic_Channel_Created",e.MonitorData="Channel_Data",e.MonitorGalacticData="Galactic_Data",e.MonitorError="Error",e.MonitorDropped="Dropped",e.MonitorChildProxyRegistered="Child_Proxy_Registered",e.MonitorChildProxyListening="Child_Proxy_Listening",e.MonitorChildProxyNotListening="Child_Proxy_Not_Listening",e.MonitorChildProxyUnRegistered="Child_Proxy_UnRegistered",e.MonitorBrokerConnectorConnected="Broker_Connector_Connected",e.MonitorBrokerConnectorDisconnected="Broker_Connector_Disconnected"}(i||(i={}));class r{build(e,t,s,n){return this._type=e,this._from=s,this._channel=t,this._data=n,this}get type(){return this._type}set type(e){this._type=e}get from(){return this._from}set from(e){this._from=e}get channel(){return this._channel}set channel(e){this._channel=e}get data(){return this._data}set data(e){this._data=e}isNewChannel(){return this._type&&this._type===i.MonitorNewChannel}isChannelGone(){return this._type&&this._channel&&this._type===i.MonitorDestroyChannel}hasData(){return!!this._data}}class o{static genUUID(){let e,t,s="";for(e=0;e<32;e++)t=16*Math.random()|0,8!==e&&12!==e&&16!==e&&20!==e||(s+="-"),s+=(12===e?4:16===e?3&t|8:t).toString(16);return s}static genUUIDShort(){return o.genUUID().substr(0,8)}static isObject(e){try{return JSON.parse(e),!0}catch(e){return!1}}static getCookie(e){const t=e+"=",s=document.cookie.split(";");for(let e=0;e<s.length;e++){let n=s[e];for(;" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(t))return n.substring(t.length,n.length)}return null}static getFabricConnectionString(e,t,s){return e||null!=t?`${e}:${t}${s}`:`${location.host}${s}`}}const a="orgId",c="orgs";var h,l;!function(e){e.MessageTypeRequest="Request",e.MessageTypeResponse="Response",e.MessageTypeError="Error",e.MessageTypeControl="Control"}(h||(h={}));class u{static rebuildId(){return`eventbus-${o.genUUID()}-${u.version}`}}u.version="1.3.5",u.id=u.rebuildId(),function(e){e.ASYNC="Async",e.SYNC="Sync"}(l||(l={}));class d{constructor(e,t,s=!0,n){this.isHandlerConfig=!0,this.returnChannel=n,this.sendChannel=e,this.body=t,this.returnChannel||(this.returnChannel=e),this.singleResponse=s}}class g{constructor(e,t=1,s=!1){this.messageError=!1,this.proxyRebroadcast=!1,this.id=e,this.version=t,this.proxyRebroadcast=s}build(e,t,s=!1){return this.messageError=s,this.payload=t,this.type=e,this}request(e){return this.build(h.MessageTypeRequest,e)}response(e){return this.build(h.MessageTypeResponse,e)}error(e){return this.build(h.MessageTypeError,e,!0)}isRequest(){return this.type===h.MessageTypeRequest}isResponse(){return this.type===h.MessageTypeResponse}isError(){return this.messageError}}var p=s(0);class b{static bufferToString(e){return String.fromCharCode.apply(null,new Uint16Array(e))}static stringToArrayBuffer(e){let t=new ArrayBuffer(2*e.length),s=new Uint16Array(t);for(let t=0,n=e.length;t<n;t++)s[t]=e.charCodeAt(t);return t}static marshal(e,t,s){return b.frame(e,t,s).toString()+"\0"}static unmarshal(e){let t,s=e.search(/\n\n/),n=e.substring(0,s).split("\n"),i=n.shift(),r={},o="",a=null;for(let e=0;e<n.length;e++)t=n[e],a=t.indexOf(":"),r[b.trim(t.substring(0,a))]=b.trim(t.substring(a+1));let c=null;for(let t=s+2;t<e.length&&(c=e.charAt(t),"\0"!==c);t++)o+=c;return b.frame(i,r,o)}static byteCount(e){e=String(e);let t=0;for(let s=0;s<e.length;s++){let n=e.charCodeAt(s);t+=n<128?1:n<2048?2:n<65536?3:n<1<<21?4:n<1<<26?5:n<1<<31?6:Number.NaN}return t}static frame(e,t,s){let n;return s instanceof ArrayBuffer&&(s=b.bufferToString(s)),n="object"==typeof s?JSON.stringify(s):s,{command:e,headers:t,body:s,toString:()=>{let i=e+"\n";if(t)for(let e in t)t.hasOwnProperty(e)&&(i=i+e+":"+t[e]+"\n");return i+="accept-version:1.2\n",i+="\n",s&&(i+=n.trim()),i}}}static trim(e){return e.replace(/^\s+/g,"").replace(/\s+$/g,"")}static genUUID(){return o.genUUID()}static genUUIDShort(){return o.genUUIDShort()}static extractStompBusCommandFromMessage(e){return null!==e?e.payload:null}static extractStompMessageFromBusCommand(e){return null!==e?e.payload:null}static extractStompMessageFromBusMessage(e){return null!==e?b.extractStompMessageFromBusCommand(b.extractStompBusCommandFromMessage(e)):null}static generateStompBrokerSubscriptionRequest(e,t,s,n,i){return{session:e,destination:t,id:s,isQueue:n,brokerPrefix:i}}static generateStompBusCommand(e,t,s,n){return{destination:s,session:t,command:e,payload:n}}static generateStompReadyMessage(e,t){let s=t||{};return b.frame("SEND",s,e)}static convertChannelToSubscription(e){return e.trim()}static generateGalacticDesintation(e,t){return e+"/"+t}static convertSubscriptionToChannel(e,t){return e.replace(t+"/","")}static convertTopicOrQueueToChannel(e,t){return e.replace(t+"/","").trim()}}function m(e){return"function"==typeof e}function f(e){return function(t){if(function(e){return m(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var C=function(e,t){return(C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])})(e,t)};function S(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function s(){this.constructor=e}C(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}function y(e){var t="function"==typeof Symbol&&Symbol.iterator,s=t&&e[t],n=0;if(s)return s.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function v(e,t){var s="function"==typeof Symbol&&e[Symbol.iterator];if(!s)return e;var n,i,r=s.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=r.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o}function _(e,t){for(var s=0,n=t.length,i=e.length;s<n;s++,i++)e[i]=t[s];return e}Object.create,Object.create;var M,w,O=((w=function(e){Error.call(e),e.stack=(new Error).stack},M=function(e){w(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}).prototype=Object.create(Error.prototype),M.prototype.constructor=M,M);function T(e,t){if(e){var s=e.indexOf(t);0<=s&&e.splice(s,1)}}var k=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e,t,s,n,i;if(!this.closed){this.closed=!0;var r=this._parentage;if(r)if(this._parentage=null,Array.isArray(r))try{for(var o=y(r),a=o.next();!a.done;a=o.next())a.value.remove(this)}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else r.remove(this);var c=this.initialTeardown;if(m(c))try{c()}catch(e){i=e instanceof O?e.errors:[e]}var h=this._teardowns;if(h){this._teardowns=null;try{for(var l=y(h),u=l.next();!u.done;u=l.next()){var d=u.value;try{E(d)}catch(e){i=null!=i?i:[],e instanceof O?i=_(_([],v(i)),v(e.errors)):i.push(e)}}}catch(e){s={error:e}}finally{try{u&&!u.done&&(n=l.return)&&n.call(l)}finally{if(s)throw s.error}}}if(i)throw new O(i)}},e.prototype.add=function(t){var s;if(t&&t!==this)if(this.closed)E(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=null!==(s=this._teardowns)&&void 0!==s?s:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&T(t,e)},e.prototype.remove=function(t){var s=this._teardowns;s&&T(s,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function E(e){m(e)?e():e.unsubscribe()}k.EMPTY;var R={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=R.delegate;return((null==s?void 0:s.setTimeout)||setTimeout).apply(void 0,_([],v(e)))},clearTimeout:function(e){var t=R.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function I(e){R.setTimeout((function(){throw e}))}function N(){}function P(e,t,s){return{kind:e,value:t,error:s}}P("C",void 0,void 0);var D=function(e){function t(t){var s,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((s=t)instanceof k||s&&"closed"in s&&m(s.remove)&&m(s.add)&&m(s.unsubscribe))&&t.add(n)):n.destination=G,n}return S(t,e),t.create=function(e,t,s){return new A(e,t,s)},t.prototype.next=function(e){this.isStopped?function(e){P("N",e,void 0)}(e):this._next(e)},t.prototype.error=function(e){this.isStopped?P("E",void 0,e):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(k),A=function(e){function t(t,s,n){var i,r=e.call(this)||this;if(m(t))i=t;else if(t){var o;i=t.next,s=t.error,n=t.complete,o=t,i=null==i?void 0:i.bind(o),s=null==s?void 0:s.bind(o),n=null==n?void 0:n.bind(o)}return r.destination={next:i?B(i):N,error:B(null!=s?s:x),complete:n?B(n):N},r}return S(t,e),t}(D);function B(e,t){return function(){for(var t=[],s=0;s<arguments.length;s++)t[s]=arguments[s];try{e.apply(void 0,_([],v(t)))}catch(e){I(e)}}}function x(e){throw e}var L,q,F,H,U,G={closed:!0,next:N,error:x,complete:N},j=function(e){function t(t,s,n,i,r){var o=e.call(this,t)||this;return o.onFinalize=r,o._next=s?function(e){try{s(e)}catch(e){t.error(e)}}:e.prototype._next,o._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,o._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,o}return S(t,e),t.prototype.unsubscribe=function(){var t,s=this.closed;e.prototype.unsubscribe.call(this),!s&&(null===(t=this.onFinalize)||void 0===t||t.call(this))},t}(D);function V(e,t){return f((function(s,n){var i=0;s.subscribe(new j(n,(function(s){n.next(e.call(t,s,i++))})))}))}!function(e){e.Connected="connected",e.Disconnected="disconnected",e.Connecting="connecting",e.Failed="failed"}(L||(L={})),function(e){e[e.Connecting=0]="Connecting",e[e.Connected=1]="Connected",e[e.Disconnected=2]="Disconnected"}(q||(q={}));class W{constructor(e,t){this.log=e,this.bus=t,this._socketConnected=!1,this._stompConnected=!1,this._useMockSocket=!1,this._transactionReceipts=new Map,this._subscriptions=new Map,this._stompConnectedObserver=new p.Subject,this._ackObserver=new p.Subject,this._subscriptionObserver=new p.Subject,this.currentConnectionState=q.Disconnected}getName(){return this.constructor.name}getSubscription(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}get connectionState(){return this.currentConnectionState}get clientSocket(){return this._socket}get socketOpenObserver(){return this._socketOpenObserver?this._socketOpenObserver:null}get socketMessageObserver(){return this._socketMessageObserver?this._socketMessageObserver:null}get socketCloseObserver(){return this._socketCloseObserver?this._socketCloseObserver:null}get socketErrorObserver(){return this._socketErrorObserver?this._socketErrorObserver:null}get socketConnectedObserver(){return this._stompConnectedObserver}get socketACKObserver(){return this._ackObserver}get socketSubscriptionObserver(){return this._subscriptionObserver}useMockSocket(){this._useMockSocket=!0}connect(e,t){return this._socket&&null!==this._stompConnectedObserver?this._stompConnectedObserver:this.create(e,t)}disconnect(e){let t=e||{};this._socket?(t.receipt="disconnect-"+o.genUUID(),this.transmit(W.STOMP_DISCONNECT,t),this._socket.close()):this.log.warn("Uable to disconnect client, no socket open",this.getName())}send(e,t,s){let n=t||{};return n.destination=e,this.transmit(W.STOMP_SEND,n,s)}subscribeToDestination(e,t,s){if(null!==this.getSubscription(t))return this.getSubscription(t);(s=s||{}).destination=e,s.id=t,this._config.getConfig().requireACK&&(s.ack="client");let n=new p.Subject;return this._subscriptions.set(t,n),this.transmit(W.STOMP_SUBSCRIBE,s),setTimeout(()=>{this._subscriptionObserver.next(b.frame(W.STOMP_SUBSCRIBE,s))}),n}unsubscribeFromDestination(e,t){(t=t||{}).id=e,this.transmit(W.STOMP_UNSUBSCRIBE,t),setTimeout(()=>{let t=this.getSubscription(e);t?(t.complete(),this.deleteSubscription(e)):this.log.debug("Tried to complete subscription that did not exist: "+e,this.getName())})}beginTransaction(e,t){let s=t||{};s.transaction=o.genUUID(),e&&(s.transaction=e),s.receipt||(s.receipt=o.genUUID());let n=new p.Subject;this._transactionReceipts.set(s.receipt,n);let i={id:s.transaction,receiptId:s.receipt,receiptObservable:n,commit:()=>{this.commit(s.transaction)},abort:()=>{this.abort(s.transaction)}};return this.log.debug("Starting STOMP Transaction: "+s.transaction,this.getName()),this.transmit(W.STOMP_BEGIN,s),i}deleteSubscription(e){this._subscriptions.delete(e)}onStompError(e){this.log.error("Error with STOMP Client on WebSocket: "+e.command+e.body,this.getName()),this.sendStompErrorToSubscribers(e.headers,e.body)}onError(e){let t;try{t=b.unmarshal(e.data)}catch(e){this.log.info("Error is not STOMP packet, cannot be unmarshalled",this.getName())}if(this.currentConnectionState=q.Disconnected,this.bus){const e=o.getFabricConnectionString(this._config.host,this._config.port,this._config.endpoint);this.log.debug("Informing Fabric subscribers that the connection has failed via store.",this.getName()),this.bus.fabric.getConnectionStateStore(e).put(e,L.Failed,L.Failed)}this.log.error("Error with WebSocket, Connection Failed",this.getName()),t&&t.hasOwnProperty("headers")&&this.sendStompErrorToSubscribers(t.headers,"Error occurred with WebSocket")}onClose(e){setTimeout(()=>{this._subscriptions.forEach((e,t)=>{this.log.debug("Unsubscribing: "+t,this.getName()),this.deleteSubscription(t)}),this.log.info("WebSocket has been closed",this.getName())}),this.currentConnectionState=q.Disconnected,this._socketConnected=!1,this._stompConnectedObserver=null,this._heartbeater&&clearInterval(this._heartbeater)}sendHeartbeat(){this._socket.send("\n")}onOpen(e,t){this._socketConnected=!0,this.log.debug("WebSocket opened",this.getName());const s=Object.assign({login:this._config.getConfig().user,passcode:this._config.getConfig().pass,"heart-beat":this._config.getConfig().heartbeatOut+","+this._config.getConfig().heartbeatIn},t||{});if(this.transmit(W.STOMP_CONNECT,s),this._config.getConfig().heartbeatOut&&this._config.getConfig().heartbeatOut>0){let e=this._config.getConfig().startIntervalFunction||setInterval;this._heartbeater=e(()=>{this.sendHeartbeat()},this._config.getConfig().heartbeatOut)}}transmit(e,t,s){return s instanceof ArrayBuffer&&(s=b.bufferToString(s)),this.sendSocketMessage(b.marshal(e,t,s),e,t)}ack(e,t){let s=t||{};s.id=e,this.transmit(W.STOMP_ACK,s),this._ackObserver.next(b.frame(W.STOMP_ACK,s))}commit(e){let t={transaction:e};this.log.debug("STOMP transaction COMMIT: "+e,this.getName()),this.transmit(W.STOMP_COMMIT,t)}abort(e){let t={transaction:e};this.log.debug("STOMP transaction ABORT: "+e,this.getName()),this.transmit(W.STOMP_ABORT,t)}onMessage(e){let t=e.data;t instanceof ArrayBuffer&&(t=b.bufferToString(t));let s=b.unmarshal(t);switch(s.command){case W.STOMP_CONNECTED:this.log.debug("STOMP client now connected, alerting subscribers",this.getName()),this._stompConnected=!0,this._stompConnectedObserver.next(!0),this.currentConnectionState=q.Connected;break;case W.STOMP_MESSAGE:if(this.log.verbose("STOMP message received: "+e.data,this.getName()),s.headers.subscription){const e=s.headers.subscription.replace(/\\c/g,":");null!==this.getSubscription(e)&&this.getSubscription(e).next(s)}this._config.getConfig().requireACK&&this.ack(s.headers["message-id"]);break;case W.STOMP_RECEIPT:let t=s.headers["receipt-id"];this.log.verbose("STOMP receipt received: "+t,this.getName());let n=this._transactionReceipts.get(t);n&&(n.next(s),n.complete()),this._transactionReceipts.delete(t),this._config.getConfig().requireACK&&this.ack(s.headers["receipt-id"]);break;case W.STOMP_ERROR:this.log.verbose("STOMP error received: "+e.data,this.getName()),this.onStompError(s)}}sendSocketMessage(e,t,s){let n="Unable to send STOMP frame, socket closed or in wrong state:";return this._socket?this._socket.readyState===WebSocket.OPEN?(this.log.debug("Sending STOMP frame down the wire",this.getName()),this._socket.send(e),!0):(this.log.error(n,this.getName()),this.sendStompErrorToSubscribers(s,n),!1):(this.log.debug(n,this.getName()),!1)}sendStompErrorToSubscribers(e,t){e&&null!==e.subscription&&null!==this.getSubscription(e.subscription)&&this.getSubscription(e.subscription).error(t)}create(e,t){let s;return this._config=e,this._socketConnected=!1,this._stompConnectedObserver=new p.Subject,this.currentConnectionState=q.Connecting,s=this._config.generateSocket(),s.binaryType="arraybuffer",this._socketOpenObserver=Object(p.fromEvent)(s,"open").pipe(V(e=>e)),this._socketCloseObserver=Object(p.fromEvent)(s,"close").pipe(V(t=>({event:t,config:e}))),this._socketErrorObserver=Object(p.fromEvent)(s,"error").pipe(V(e=>e)),this._socketMessageObserver=Object(p.fromEvent)(s,"message").pipe(V(e=>e)),this._socketOpenObserver.subscribe(e=>this.onOpen(e,t)),this._socketMessageObserver.subscribe(e=>this.onMessage(e)),this._socketCloseObserver.subscribe(t=>this.onClose(e)),this._socketErrorObserver.subscribe(e=>this.onError(e)),this._socket=s,this._stompConnectedObserver}}W.STOMP_CONFIGURED="CONFIGURED",W.STOMP_CONNECT="CONNECT",W.STOMP_CONNECTED="CONNECTED",W.STOMP_CONNECTED_DUPLICATE="CONNECTED_DUPLICATE",W.STOMP_MESSAGE="MESSAGE",W.STOMP_RECEIPT="RECEIPT",W.STOMP_DISCONNECT="DISCONNECT",W.STOMP_DISCONNECTING="DISCONNECTING",W.STOMP_DISCONNECTED="DISCONNECTED",W.STOMP_SUBSCRIBE="SUBSCRIBE",W.STOMP_SUBSCRIBED="SUBSCRIBED",W.STOMP_UNSUBSCRIBE="UNSUBSCRIBE",W.STOMP_UNSUBSCRIBED="UNSUBSCRIBED",W.STOMP_INVALIDMONITOR="INVALID_MONITOR",W.STOMP_SEND="SEND",W.STOMP_ACK="ACK",W.STOMP_BEGIN="BEGIN",W.STOMP_ABORT="ABORT",W.STOMP_ERROR="ERROR",W.STOMP_COMMIT="COMMIT";class K{constructor(e,t){this.url=e,this.protocols=t,this.events={},this._socketState=WebSocket.OPEN,this.transaction=!1,setTimeout(()=>this.triggerEvent("open",[!0]),0)}set binaryType(e){this._binaryType=e}get binaryType(){return this._binaryType}set socketState(e){this._socketState=e}get readyState(){return this._socketState}send(e){let t=b.unmarshal(e);switch(t.command){case W.STOMP_CONNECT:setTimeout(()=>{this._socketState=WebSocket.OPEN,this.triggerEvent("message",[{data:b.marshal(W.STOMP_CONNECTED,{},"")}])},0);break;case W.STOMP_SEND:this.transaction||setTimeout(()=>{this.triggerEvent("message",[{data:b.marshal(W.STOMP_MESSAGE,t.headers,t.body)}])},0);break;case W.STOMP_BEGIN:this.transaction=!0,this.transactionId=t.headers.transaction,this.receiptId=t.headers.receipt;break;case W.STOMP_COMMIT:case W.STOMP_ABORT:this.transaction=!1,setTimeout(()=>{this.triggerEvent("message",[{data:b.marshal(W.STOMP_RECEIPT,{"receipt-id":this.receiptId})}])},0);break;case W.STOMP_ERROR:this.transaction=!1,setTimeout(()=>{this.triggerEvent("message",[{data:b.marshal(W.STOMP_ERROR,t.headers,t.body)}])},0);break;case W.STOMP_DISCONNECT:setTimeout(()=>{this._socketState=WebSocket.CLOSED,this.triggerEvent("close")},0)}}close(){}addEventListener(e,t){this.events.hasOwnProperty(e)?this.events[e].push(t):this.events[e]=[t]}removeEventListener(e){this.events.hasOwnProperty(e)&&delete this.events[e]}triggerEvent(e,t){if(!this.events.hasOwnProperty(e))return;t&&t.length||(t=[]);let s=this.events[e],n=s.length;for(let e=0;e<n;e++)s[e].apply(null,t);return this}}class z{static validateMonitorMessage(e){let t=e.payload;return!(!t||!t.channel)}static validateConnectionMessage(e){let t=b.extractStompBusCommandFromMessage(e);switch(t.command){case W.STOMP_CONNECT:if(null!==t.payload)return!0;break;case W.STOMP_DISCONNECT:if(null!==t.session)return!0}return!1}static validateSubscriptionMessage(e){let t=b.extractStompBusCommandFromMessage(e);switch(t.command){case W.STOMP_SUBSCRIBE:case W.STOMP_UNSUBSCRIBE:if(null!==t.payload&&null!==t.destination)return!0}return!1}static validateInboundMessage(e){let t=b.extractStompBusCommandFromMessage(e);switch(t.command){case W.STOMP_SEND:if(null!==t.destination&&null!==t.session){let e=t.payload;if(e&&e.command===W.STOMP_SEND&&null!==e.body)return!0}}return!1}}class ${static isPayloadFabricRequest(e){if(!e)return!1;let t=!1,s=!1,n=!1,i=!1,r=!1;return e.hasOwnProperty("request")&&(t=!0),e.hasOwnProperty("created")&&(r=!0),e.hasOwnProperty("id")&&(s=!0),e.hasOwnProperty("payload")&&(n=!0),e.hasOwnProperty("version")&&(i=!0),t&&s&&n&&i&&r}static isPayloadFabricResponse(e){if(!e)return!1;let t=!1,s=!1,n=!1,i=!1,r=!1,o=!1,a=!1;return e.hasOwnProperty("created")&&(a=!0),e.hasOwnProperty("id")&&(t=!0),e.hasOwnProperty("payload")&&(s=!0),e.hasOwnProperty("version")&&(o=!0),e.hasOwnProperty("error")&&(n=!0),e.hasOwnProperty("errorCode")&&(i=!0),e.hasOwnProperty("errorMessage")&&(r=!0),t&&s&&o&&a&&n&&i&&r}}class X{constructor(e){this.log=e,this.reconnectDelay=5e3,this.connectDelay=20,this.connectingMap=new Map,this.currentSessionMap=new Map,this.channelBrokerIdentitiesMap=new Map,this._errorObservables=new Map,this._closeObservables=new Map,this.reconnecting=!1}static fireSubscriptionCommand(e,t,s,n,i,r,o){let a=b.generateStompBrokerSubscriptionRequest(t,s,n,r,o),c=b.generateStompBusCommand(i,t,s,a);e.api.send(ee.subscription,(new g).request(c),X.serviceName)}static fireSubscribeCommand(e,t,s,n,i,r){X.fireSubscriptionCommand(e,t,s,n,W.STOMP_SUBSCRIBE,i,r)}static fireUnSubscribeCommand(e,t,s,n,i,r){X.fireSubscriptionCommand(e,t,s,n,W.STOMP_UNSUBSCRIBE,i,r)}static fireConnectCommand(e,t=null){let s=b.generateStompBusCommand(W.STOMP_CONNECT,null,null,t);e.api.send(ee.connection,(new g).request(s),X.serviceName)}static fireDisconnectCommand(e,t){let s=b.generateStompBusCommand(W.STOMP_DISCONNECT,t);e.api.send(ee.connection,(new g).request(s),X.serviceName)}getName(){return this.constructor.name}setBus(e){this.bus=e}init(e){this.setBus(e);let t=this.bus.api.getRequestChannel(ee.connection,this.getName()),s=this.bus.api.getRequestChannel(ee.subscription,this.getName()),i=this.bus.api.getRequestChannel(n.stream,this.getName());t.subscribe(e=>{this.processConnectionMessage(e)}),s.subscribe(e=>{this.processSubscriptionMessage(e)}),i.subscribe(e=>{this.processMonitorStreamMessage(e)}),this._sessions=new Map,this._galacticChannels=new Map,this._privateChannels=new Map}get galacticChannels(){return this._galacticChannels}get privateChannels(){return this._privateChannels}getSession(e){return this._sessions.get(e)}get sessions(){return this._sessions}processMonitorStreamMessage(e){if(!z.validateMonitorMessage(e))return void this.sendBusCommandResponse(W.STOMP_INVALIDMONITOR);let t=e.payload;switch(t.type){case i.MonitorNewGalacticChannel:const e=t.data||{isPrivate:!1,brokerIdentity:null};this.openGalacticChannel(t.channel,e);break;case i.MonitorGalacticData:Array.from(this._sessions.values()).filter(e=>this.channelBrokerIdentitiesMap.get(t.channel).has(o.getFabricConnectionString(e.config.host,e.config.port,e.config.endpoint))).map(e=>e.id).forEach(e=>this.sendGalacticMessage(t.channel,t.data,e));break;case i.MonitorCompleteChannel:case i.MonitorGalacticUnsubscribe:this._galacticChannels.get(t.channel)&&this.closeGalacticChannel(t.channel,t.data)}}sendGalacticMessage(e,t,s){$.isPayloadFabricRequest(t)||this.log.warn("Outbound message being sent over WebSocket that has not been correctly wrapped. You may not receive a response, you may receive an error. Please make sure you use fabric.generateFabricRequest() if you're not using auto-generated services",this.getName());let n=[b.convertChannelToSubscription(e)];this._sessions.forEach(i=>{const r=o.getFabricConnectionString(i.config.host,i.config.port,i.config.endpoint);if(s===i.id){i.applicationDestinationPrefix&&n.splice(0,0,i.applicationDestinationPrefix),this._privateChannels.get(e)[r]&&n.splice(1,0,"queue");const s=n.join("/"),o=b.generateStompBusCommand(W.STOMP_MESSAGE,i.id,s,b.generateStompReadyMessage(t,this.getGlobalHeaders()));this.log.debug("Sending Galactic Message for session "+i.id+" to destination "+s,this.getName()),this.sendPacket(o)}})}generateSubscriptionId(e,t){return e+"-"+t}openGalacticChannel(e,t){let s=b.convertChannelToSubscription(e);if(!t.brokerIdentity){const s=this.getDefaultBrokerIdentity();if(!s.success)return void(s.sessionsNum>1?this.log.error("More than one STOMP session was detected when trying to open galactic channel '"+e+"'. You need to explicitly specify the target fabric broker in the second argument to bus.markChannelAsGalactic()"):0===s.sessionsNum&&this.log.warn("No session registered"));t.brokerIdentity=s.brokerIdentityStr}this.channelBrokerIdentitiesMap.has(e)?this.channelBrokerIdentitiesMap.get(e).add(t.brokerIdentity):this.channelBrokerIdentitiesMap.set(e,new Set([t.brokerIdentity])),this._galacticChannels.has(e)||this._galacticChannels.set(e,{connectedBrokers:0}),this._privateChannels.has(e)||this._privateChannels.set(e,{}),this._privateChannels.get(e)[t.brokerIdentity]=t.isPrivate,this.isSessionEstablished(t)&&this._sessions.forEach(n=>{if(t.brokerIdentity===o.getFabricConnectionString(n.config.host,n.config.port,n.config.endpoint)){const i=n.config,r=this.generateSubscriptionId(n.id,s),o=t.isPrivate?i.queueLocation:i.topicLocation,a=b.generateGalacticDesintation(o,s),c=b.generateStompBrokerSubscriptionRequest(n.id,a,r,t.isPrivate,o);this._galacticChannels.get(e).connectedBrokers++,this.subscribeToDestination(c)}})}closeGalacticChannel(e,t){if(!t.brokerIdentity){const s=this.getDefaultBrokerIdentity();if(!s.success)return void(s.sessionsNum>1?this.log.error("More than one STOMP session was detected when trying to close galactic channel '"+e+"'. You need to explicitly specify the target fabric broker in the second argument to bus.markChannelAsLocal()"):0===s.sessionsNum&&this.log.warn("No session registered"));t.brokerIdentity=s.brokerIdentityStr}let s=b.convertChannelToSubscription(e);this._sessions.size>=1?(this._sessions.forEach(n=>{const i=n.config,r=o.getFabricConnectionString(i.host,i.port,i.endpoint),a=this._privateChannels.get(e)[r],c=this.generateSubscriptionId(n.id,s),h=this._privateChannels.get(e)[r]?i.queueLocation:i.topicLocation,l=b.generateGalacticDesintation(h,s),u=b.generateStompBrokerSubscriptionRequest(n.id,l,c,a,h);t.brokerIdentity===r&&this.unsubscribeFromDestination(u)}),this._galacticChannels.get(e).connectedBrokers--,0===this._galacticChannels.get(e).connectedBrokers&&this._galacticChannels.delete(e),delete this._privateChannels.get(e)[t.brokerIdentity],this.channelBrokerIdentitiesMap.get(e).delete(t.brokerIdentity),0===Object.keys(this._privateChannels.get(e)).length&&this._privateChannels.delete(e)):this.log.warn("unable to close galactic channel, no open sessions.","BrokerConnector")}processSubscriptionMessage(e){if(!z.validateSubscriptionMessage(e))return void this.log.warn("unable to validate inbound subscription message, invalid","BrokerConnector");let t=b.extractStompBusCommandFromMessage(e),s=t.payload;switch(t.command){case W.STOMP_SUBSCRIBE:this.log.info("subscribing to destination: "+s.destination,this.getName()),this.subscribeToDestination(s);break;case W.STOMP_UNSUBSCRIBE:this.log.info("unsubscribing from destination: "+s.destination,this.getName()),this.unsubscribeFromDestination(s)}}processConnectionMessage(e){if(!z.validateConnectionMessage(e))return void this.log.warn("unable to validate connection message, invalid command",this.getName());let t=b.extractStompBusCommandFromMessage(e);switch(t.command){case W.STOMP_CONNECT:let e=t.payload;this.sendBusCommandResponse(W.STOMP_CONFIGURED),this.bus.api.tickEventLoop(()=>{this.connectClient(e)},this.connectDelay);break;case W.STOMP_DISCONNECT:this.sendBusCommandResponse(W.STOMP_DISCONNECTING),this.disconnectClient(t.session)}}sendBusCommandResponseRaw(e,t=ee.status,s=!1,n=!1){let i=new g(e.payload).response(e);n&&(i=new g(e.payload).error(e)),this.bus.api.send(t,i,this.getName()),s&&this.bus.api.send(ee.status,i,this.getName())}sendBusCommandResponse(e,t=ee.status,s=!1){let n=b.generateStompBusCommand(e);this.sendBusCommandResponseRaw(n,t,s)}getGlobalHeaders(){return{[this.bus.fabric.accessTokenHeaderKey]:this.bus.fabric.getAccessToken()}}connectClient(e){const t=o.getFabricConnectionString(e.host,e.port,e.endpoint);if(this.currentSessionMap.has(t)&&this.currentSessionMap.get(t).client&&(this.currentSessionMap.get(t).client.connectionState===q.Connecting||this.currentSessionMap.get(t).client.connectionState===q.Connected))return;let s=new te(e,this.log,this.bus);this.currentSessionMap.set(t,s);let n=s.connect(this.getGlobalHeaders());this.connectingMap.set(t,!0),e.connectionSubjectRef=n,n.subscribe(()=>{if(clearInterval(this.reconnectTimerInstance),this.reconnecting=!1,s.connectionCount++,s.connectionCount<s.config.brokerConnectCount&&this.log.info("Connection message "+s.connectionCount+" of "+e.brokerConnectCount+" received",this.getName()),s.config.brokerConnectCount===s.connectionCount){if(!s.connected){let e=b.generateStompBusCommand(W.STOMP_CONNECTED,s.id,void 0,o.getFabricConnectionString(s.config.host,s.config.port,s.config.endpoint));this.sendBusCommandResponseRaw(e,ee.connection,!0),this.bus.api.getMonitorStream().send((new g).response((new r).build(i.MonitorBrokerConnectorConnected,ee.connection,this.getName(),""))),this._errorObservables.set(s.id,s.client.socketErrorObserver),this._closeObservables.set(s.id,s.client.socketCloseObserver),this._sessions.set(s.id,s),this.subscribeToClientObservables(s),this._galacticChannels.forEach((e,n)=>{const i=o.getFabricConnectionString(s.config.host,s.config.port,s.config.endpoint);this.channelBrokerIdentitiesMap.get(n).has(i)&&this.openGalacticChannel(n,{isPrivate:this._privateChannels.get(n)[i],brokerIdentity:t})}),s.connected=!0}}else if(s.config.brokerConnectCount>s.connectionCount){let e=b.generateStompBusCommand(W.STOMP_CONNECTED_DUPLICATE,s.id);this.sendBusCommandResponseRaw(e,ee.connection,!0)}this.bus.fabric.getConnectionStateStore(t).put(t,L.Connected,L.Connected)})}disconnectClient(e){let t=this._sessions.get(e);t&&null!==t?(this.clearGalacticSubscriptionsFromSession(t),t.disconnect(this.getGlobalHeaders()),this._sessions.delete(e)):this.log.warn("unable to disconnect client, no active session with id: "+e,"BrokerConnector")}sendPacket(e){let t=this._sessions.get(e.session);if(t&&null!==t){let s=e.payload;s.headers.session?this.log.debug("sendPacket(): message headers already contain sessionId",this.getName()):(this.log.debug("sendPacket(): adding local broker session ID to message: "+e.session,this.getName()),s.headers.session=e.session),t.send(e.destination,s.headers,s.body)}else this.log.warn("unable to send packet, session is empty",this.getName())}clearGalacticSubscriptionsFromSession(e){e&&e.getGalacticSubscriptions()&&(e.getGalacticSubscriptions().forEach((e,t)=>{e&&(e.unsubscribe(),0===this._galacticChannels.get(t).connectedBrokers&&this.bus.api.close(t,this.getName()))}),e.getGalacticSubscriptions().clear())}reconnectTimer(e){if(e.autoReconnect){const t=()=>{this.log.warn("Trying to reconnect to broker....",this.getName()),this.bus.api.tickEventLoop(()=>{this.connectClient(e)},this.connectDelay)};this.reconnectTimerInstance=setInterval(t,this.reconnectDelay)}}subscribeToClientObservables(e){this._closeObservables.get(e.id).subscribe(e=>{const t=[];this.log.warn("WebSocket to broker closed!",this.getName()),this.sessions.forEach(s=>{s.config.host===e.config.host&&s.config.port===e.config.port&&t.push(s.id)}),t.forEach(t=>{const s=this.sessions.get(t);for(let[t,n]of this.channelBrokerIdentitiesMap.entries())this._galacticChannels.get(t).connectedBrokers--,e.config.autoReconnect||n.delete(o.getFabricConnectionString(s.config.host,s.config.port,s.config.endpoint));this.clearGalacticSubscriptionsFromSession(s),this.sessions.delete(t)}),this.reconnecting||(this.log.info("Starting re-connection timer",this.getName()),this.reconnecting=!0,this.reconnectTimer(e.config)),this.sendBusCommandResponse(W.STOMP_DISCONNECTED,ee.connection,!0)}),this._errorObservables.get(e.id).subscribe(e=>{this.log.error("Error occurred with WebSocket, Unable to connect to broker!",this.getName()),this.sessions.forEach(e=>this.clearGalacticSubscriptionsFromSession(e)),this._sessions.clear();let t=b.generateStompBusCommand(W.STOMP_ERROR,"","",e);this.sendBusCommandResponseRaw(t,ee.error,!0,!0)})}subscribeToDestination(e){let t=this._sessions.get(e.session);if(t&&null!==t){let s=t.subscribe(e.destination,e.id,this.getGlobalHeaders()),n=b.generateStompBusCommand(W.STOMP_SUBSCRIBED,t.id,e.destination);const i=b.convertTopicOrQueueToChannel(e.destination,e.brokerPrefix),r=this.bus.api.getRequestChannel(i,this.getName()).subscribe(e=>{this.sendGalacticMessage(i,e.payload,t.id)});t.addGalacticSubscription(i,r),this.sendBusCommandResponseRaw(n,ee.subscription,!0);let o=s.subscribe(s=>{let n=b.convertSubscriptionToChannel(e.destination,e.isQueue?t.config.queueLocation:t.config.topicLocation),i=JSON.parse(s.body);const r=this.bus.api.getChannelObject(n);$.isPayloadFabricResponse(i),i&&i.error?r.stream.next(new g(i.id).error(i)):r.stream.next(new g(i.id).response(i))});this._closeObservables.get(t.id).subscribe(()=>{o.unsubscribe()})}else{let e=b.generateStompBusCommand(W.STOMP_ERROR,"","","cannot subscribe, session does not exist.");this.sendBusCommandResponseRaw(e,ee.error,!0,!0)}}unsubscribeFromDestination(e){let t=this._sessions.get(e.session);if(t&&null!==t){t.unsubscribe(e.id,this.getGlobalHeaders());let s=b.generateStompBusCommand(W.STOMP_UNSUBSCRIBED,t.id,e.destination);this.sendBusCommandResponseRaw(s,ee.subscription,!0);const n=b.convertTopicOrQueueToChannel(e.destination,e.brokerPrefix),i=t.getGalacticSubscription(n);i?(i.unsubscribe(),t.removeGalacticSubscription(n),this.bus.api.close(n,this.getName())):(this.log.warn("unable to unsubscribe, no galactic subscription found for id: "+e.session,this.getName()),this.bus.api.close(n,this.getName()))}else this.log.warn("unable to unsubscribe, no session found for id: "+e.session,this.getName())}isSessionEstablished(e){return Array.from(this._sessions.values()).some(t=>o.getFabricConnectionString(t.config.host,t.config.port,t.config.endpoint)===e.brokerIdentity)}getDefaultBrokerIdentity(){if(this._sessions.size>1)return{success:!1,sessionsNum:this._sessions.size,brokerIdentityStr:null};const e=Array.from(this._sessions.values())[0];return e?{success:!0,sessionsNum:1,brokerIdentityStr:o.getFabricConnectionString(e.config.host,e.config.port,e.config.endpoint)}:{success:!1,sessionsNum:0,brokerIdentityStr:null}}}X.serviceName="stomp.service",function(e){e.FabricConnection="fabric-connection",e.XsrfToken="xsrf-token"}(F||(F={})),function(e){e.CSP_AUTH_TOKEN="csp-auth-token",e.CUSTOM_HEADER_PREFIX="X-",e.XSRF_TOKEN="XSRF-TOKEN"}(H||(H={})),function(e){e.State="state"}(U||(U={}));class Y{constructor(e=o.genUUID(),t=1,s){this.id=e,this.version=t,this.created=Date.now(),s&&(this.headers=s)}}class J extends Y{constructor(e,t,s,n,i){super(s,n),this.request=e,this.payload=t,this.headers=i}}class Q extends Y{constructor(e,t,s,n,i,r){super(i,r),this.payload=e,this.error=t,this.errorMessage=n,this.errorCode=s}}class Z{constructor(e){this.bus=e,this.accessTokenSessionStorageKey=H.CSP_AUTH_TOKEN,this.xsrfTokenEnabled=!1,this.xsrfTokenStoreKey=`${H.CUSTOM_HEADER_PREFIX}${H.XSRF_TOKEN}`,this._accessTokenHeaderKey="accessToken",this._sendAccessTokenDuringHandshake=!1,this.bus=e,this.headersStore=this.bus.stores.createStore("transport-headers-store"),this.connectedMap=new Map,this.sessionIdMap=new Map,this.connectHandlerMap=new Map,this.disconnectHandlerMap=new Map,this.connectionStoreMap=new Map}getDefaultConnectionString(){return 1===this.connectionStoreMap.size?this.connectionStoreMap.keys().next().value.toString():(0===this.connectionStoreMap.size?this.bus.logger.error("Could not determine the default connection string because fabric.connect() likely was not called first. You can either call fabric.connect() first or optionally provide a connection string, if you know it, to the method you were calling as an argument.","FabricApi"):this.bus.logger.error("Could not determine the default connection string. There is more than one active connection. Please provide the connection string manually","FabricApi"),"")}getConnectionStateStore(e){let t;return e=e||this.getDefaultConnectionString(),this.connectionStoreMap.has(e)?t=this.connectionStoreMap.get(e):(t=this.bus.stores.createStore(F.FabricConnection),this.connectionStoreMap.set(e,t)),t}isConnected(e){return e=e||this.getDefaultConnectionString(),this.connectedMap.has(e)&&this.connectedMap.get(e)}whenConnectionStateChanges(e){e=e||this.getDefaultConnectionString(),this.connectionStoreMap.has(e)||this.connectionStoreMap.set(e,this.bus.stores.createStore(F.FabricConnection));const t=this.bus.stores.getStore(F.FabricConnection).get(e);return void 0!==t&&this.bus.api.tickEventLoop(()=>{this.bus.stores.getStore(F.FabricConnection).put(e,t,t)}),this.connectionStoreMap.get(e).onChange(e,L.Disconnected,L.Connected,L.Failed)}connect(e,t,s,n,i="/fabric",r=!1,a="/topic",c="/queue",h=1,l=!0){const u=o.getFabricConnectionString(s,n,i);if(this.connectedMap.get(u))this.connectHandlerMap.get(u)&&this.connectHandlerMap.get(u)(this.sessionIdMap.get(u));else{this.connectionStoreMap.get(u)||this.connectionStoreMap.set(u,this.bus.stores.createStore(F.FabricConnection)),this.createWindowConnectionEventListeners(u),this.connectHandlerMap.set(u,e),this.disconnectHandlerMap.set(u,t);const o=e=>{this.setConnected(u),this.sessionIdMap.set(u,e),this.connectHandlerMap.get(u)(u),this.fabricDisconnectHandler||(this.fabricDisconnectHandler=this.bus.listenStream("transport-services::broker.connector-status"),this.fabricDisconnectHandler.handle(e=>{switch(e.command){case"DISCONNECTED":this.setDisconnected(u),this.disconnectHandlerMap.get(u)&&this.disconnectHandlerMap.get(u)()}}))};this.bus.api.tickEventLoop(()=>{this.bus.connectBridge(o,i,a,c,h,s,n,"/pub",null,null,r,l)})}}disconnect(e){e=e||this.getDefaultConnectionString(),X.fireDisconnectCommand(this.bus,this.sessionIdMap.get(e)),this.setDisconnected(e)}setFabricCurrentOrgId(e){this.bus.stores.createStore(c).put(a,e,null)}createWindowConnectionEventListeners(e){window&&(window.addEventListener("offline",()=>{this.setDisconnected(e),this.disconnectHandlerMap.has(e)&&this.disconnectHandlerMap.get(e)()}),window.addEventListener("online",()=>{this.setConnected(e),this.connectHandlerMap.has(e)&&this.connectHandlerMap.get(e)(this.sessionIdMap.get(e))}))}setConnected(e){e=e||this.getDefaultConnectionString(),this.connectedMap.set(e,!0)}setDisconnected(e){e=e||this.getDefaultConnectionString(),this.connectedMap.set(e,!1),this.connectionStoreMap.get(e).put(e,L.Disconnected,L.Disconnected)}generateFabricRequest(e,t,s){return t||(t=""),this.bus.fabric.isXsrfTokenEnabled()&&(s=Object.assign(Object.assign({},s),{[this.bus.fabric.getXsrfTokenStoreKey()]:this.bus.fabric.getXsrfToken()})),new J(e,t,o.genUUID(),1,s)}generateFabricResponse(e,t,s=!1,n=0,i="",r=1){return t||(t=""),new Q(t,s,n,i,e,r)}getFabricVersion(e){let t;return e=e||this.getDefaultConnectionString(),this.bus.markChannelAsGalactic(Z.versionChannel,e),t=this.connectedMap.get(e)?this.bus.requestOnceWithId(o.genUUID(),Z.versionChannel,this.generateFabricRequest("version","")):null,t?t.getObservable(h.MessageTypeResponse).pipe(V(e=>e.payload)):Object(p.of)("Version unavailable, not connected to fabric")}setAccessTokenSessionStorageKey(e){this.bus.logger.debug("Setting access token session storage key to: "+e,"FabricApi"),this.accessTokenSessionStorageKey=e}getAccessTokenSessionStorageKey(){return this.accessTokenSessionStorageKey}get getAccessTokenFunction(){return this._getAccessTokenFunction}set getAccessTokenFunction(e){this._getAccessTokenFunction=e}get accessTokenHeaderKey(){return this._accessTokenHeaderKey}set accessTokenHeaderKey(e){this._accessTokenHeaderKey=e}getAccessToken(){let e;if(this.getAccessTokenFunction)e=this.getAccessTokenFunction();else{const t=this.getAccessTokenSessionStorageKey();e=sessionStorage.getItem(t)}return e||""}get sendAccessTokenDuringHandshake(){return this._sendAccessTokenDuringHandshake}set sendAccessTokenDuringHandshake(e){this._sendAccessTokenDuringHandshake=e}get protocols(){return this._protocols}set protocols(e){this._protocols=e}setXsrfToken(e){this.bus.stores.createStore(F.XsrfToken).put(this.getXsrfTokenStoreKey(),e,"xsrftokenSet")}getXsrfToken(){const e=o.getCookie(this.getXsrfTokenStoreKey().replace(H.CUSTOM_HEADER_PREFIX,""));return null!==e?e:this.bus.stores.createStore(F.XsrfToken).get(this.getXsrfTokenStoreKey())||""}setXsrfTokenStoreKey(e){this.bus.logger.debug("Setting XSRF token store key to: "+e,"FabricApi"),this.xsrfTokenStoreKey=e}getXsrfTokenStoreKey(){return this.xsrfTokenStoreKey}isXsrfTokenEnabled(){return this.xsrfTokenEnabled}setXsrfTokenEnabled(e){e&&this.bus.stores.createStore(F.XsrfToken),this.xsrfTokenEnabled=e}useFabricRestService(){this.bus.logger.info("Switching to Fabric based RestService, all REST calls will be routed via fabric","FabricApi"),this.bus.markChannelAsGalactic("fabric-rest")}useLocalRestService(){this.bus.logger.info("Switching local RestService, all REST calls will be routed via browser","FabricApi"),this.bus.markChannelAsLocal("fabric-rest")}getGlobalHttpHeaders(){return this.headersStore.get("global-headers")}}Z.versionChannel="fabric-version";class ee{}ee.connection="transport-services::broker.connector-connection",ee.subscription="transport-services::broker.connector-subscription",ee.messages="transport-services::broker.connector-messages",ee.error="transport-services::broker.connector-error",ee.status="transport-services::broker.connector-status";class te{constructor(e,t,s){this.log=t,this.bus=s,this.isConnected=!1,this.connCount=0,this._config=e,this._client=new W(t,s),this._id=o.genUUID(),e.sessionId&&(this._id=e.sessionId),this._subscriptions=new Map,this.galacticSubscriptions=new Map,e.applicationDestinationPrefix&&(this._applicationDestinationPrefix=e.applicationDestinationPrefix)}get connected(){return this.isConnected}set connected(e){this.isConnected=e}get connectionCount(){return this.connCount}set connectionCount(e){this.connCount=e}get config(){return this._config}get client(){return this._client}get id(){return this._id}get applicationDestinationPrefix(){return this._applicationDestinationPrefix}connect(e){return this._client.connect(this._config,e)}send(e,t,s){return this._client.send(e,t,s)}subscribe(e,t,s){let n=this._client.subscribeToDestination(e,t,s);return this._subscriptions.set(t,n),n}unsubscribe(e,t){this._client.unsubscribeFromDestination(e,t),this._subscriptions.delete(e)}disconnect(e){this._client.disconnect(e)}addGalacticSubscription(e,t){this.galacticSubscriptions.has(e)||this.galacticSubscriptions.set(e,t)}getGalacticSubscription(e){return this.galacticSubscriptions.get(e)}removeGalacticSubscription(e){this.galacticSubscriptions.has(e)&&this.galacticSubscriptions.delete(e)}getGalacticSubscriptions(){return this.galacticSubscriptions}}class se{constructor(e,t,s,n,i,r,o,a,c=0,h=3e4){this._endpoint=e,this._host=t,this._port=s,this._user=n,this._pass=i,this._useSSL=r,this._applicationDestinationPrefix=o,this._requireACK=a,this._heartbeatIn=c,this._heartbeatOut=h,this._useTopics=!0,this._useQueues=!1,this._topicLocation="/topic",this._queueLocation="/queue",this._accessTokenHeaderKey="accessToken",this._sendAccessTokenDuringHandshake=!1,this.numBrokerConnect=1,this.autoReconnect=!0,this._testMode=!1}static generate(e,t,s,n,i,r,o){return new se(e,t,s,i,r,n,o)}set brokerConnectCount(e){this.numBrokerConnect=e}get brokerConnectCount(){return this.numBrokerConnect}set topicLocation(e){this._topicLocation=e}get topicLocation(){return this._topicLocation}set queueLocation(e){this._queueLocation=e}get queueLocation(){return this._queueLocation}set useTopics(e){this._useTopics=e}set useQueues(e){this._useQueues=e}get useTopics(){return this._useTopics}get useQueues(){return this._useQueues}get host(){return this._host}get endpoint(){return this._endpoint}get port(){return this._port}get user(){return this._user}get pass(){return this._pass}get useSSL(){return this._useSSL}get requireACK(){return this._requireACK}get testMode(){return this._testMode}set testMode(e){this._testMode=e}get startIntervalFunction(){return this._startIntervalFunction}set startIntervalFunction(e){this._startIntervalFunction=e}set heartbeatIn(e){this._heartbeatIn=e}get heartbeatIn(){return this._heartbeatIn}set heartbeatOut(e){this._heartbeatOut=e}get heartbeatOut(){return this._heartbeatOut}set getAccessTokenFunction(e){this._getAccessTokenFunction=e}get accessToken(){if(!this._getAccessTokenFunction)throw new Error("getAccessTokenFunction not set");return this._getAccessTokenFunction()}set accessTokenHeaderKey(e){this._accessTokenHeaderKey=e}get accessTokenHeaderKey(){return this._accessTokenHeaderKey}set sendAccessTokenDuringHandshake(e){this._sendAccessTokenDuringHandshake=e}get sendAccessTokenDuringHandshake(){return this._sendAccessTokenDuringHandshake}set protocols(e){this._protocols=e}get protocols(){return this._protocols}getConfig(){return{endpoint:this._endpoint,host:this._host,port:this._port,user:this._user,pass:this._pass,requireACK:this._requireACK,useSSL:this._useSSL,heartbeatIn:this._heartbeatIn,heartbeatOut:this._heartbeatOut,applicationDestinationPrefix:this._applicationDestinationPrefix,startIntervalFunction:this._startIntervalFunction}}get applicationDestinationPrefix(){return this._applicationDestinationPrefix}get config(){return this.getConfig()}generateSocket(){let e=this.protocols;if(e&&(e=e.slice()),this.sendAccessTokenDuringHandshake){const t=this.accessToken,s=`${this.accessTokenHeaderKey}.${t}`;e||(e=[]),e.push(s)}return this._testMode?new K(this.generateConnectionURI(),e):new WebSocket(this.generateConnectionURI(),e)}generateConnectionURI(){let e="https:"===window.location.protocol?"wss":"ws",t=window.location.host;return this._useSSL&&(e="wss"),this._host&&(t=this._host),this._port&&-1!==this._port&&(t+=":"+this._port),e+"://"+t+this._endpoint}}class ne{constructor(e){this._name=e,this._refCount=0,this._streamObject=new p.Subject,this._closed=!1,this._galactic=!1,this._private=!1,this.subscribers=new Map,this.observers=new Map}get stream(){return this._streamObject}createSubscriber(){const e=b.genUUID();return this.subscribers.set(e,{id:e,subscribed:(new Date).getDate()}),e}removeSubscriber(e){return this.subscribers.delete(e)}getSubscriber(e){return this.subscribers.get(e)}createObserver(){const e=o.genUUID();return this.observers.set(e,{id:e,subscribed:(new Date).getDate()}),this.latestObserver=e,e}removeObserver(e){return this.observers.delete(e)}getObserver(e){return this.observers.get(e)}get name(){return this._name}get isClosed(){return this._closed}send(e){setTimeout(()=>{this._streamObject.next(e)})}error(e){this._streamObject.error(e)}complete(){this._closed=!0,this._streamObject.complete()}increment(){return++this._refCount}decrement(){return this._refCount>0&&--this._refCount,this._refCount}get refCount(){return this._refCount}setGalactic(){return this._galactic=!0,this}setLocal(){return this._galactic=!1,this}get galactic(){return this._galactic}setPrivate(){this._private=!0}setPublic(){this._private=!1}get isPrivate(){return this._private}}function ie(e,t){return f((function(s,n){var i=0;s.subscribe(new j(n,(function(s){return e.call(t,s,i++)&&n.next(s)})))}))}var re,oe,ae,ce=function(e){function t(t,s){return e.call(this)||this}return S(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(k),he={setInterval:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var s=he.delegate;return((null==s?void 0:s.setInterval)||setInterval).apply(void 0,_([],v(e)))},clearInterval:function(e){var t=he.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},le=function(e){function t(t,s){var n=e.call(this,t,s)||this;return n.scheduler=t,n.work=s,n.pending=!1,n}return S(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var s=this.id,n=this.scheduler;return null!=s&&(this.id=this.recycleAsyncId(n,s,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(n,this.id,t),this},t.prototype.requestAsyncId=function(e,t,s){return void 0===s&&(s=0),he.setInterval(e.flush.bind(e,this),s)},t.prototype.recycleAsyncId=function(e,t,s){if(void 0===s&&(s=0),null!=s&&this.delay===s&&!1===this.pending)return t;he.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var s=this._execute(e,t);if(s)return s;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var s,n=!1;try{this.work(e)}catch(e){n=!0,s=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),s},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,s=this.scheduler,n=s.actions;this.work=this.state=this.scheduler=null,this.pending=!1,T(n,this),null!=t&&(this.id=this.recycleAsyncId(s,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(ce),ue={now:function(){return(ue.delegate||Date).now()},delegate:void 0},de=function(){function e(t,s){void 0===s&&(s=e.now),this.schedulerActionCtor=t,this.now=s}return e.prototype.schedule=function(e,t,s){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(s,t)},e.now=ue.now,e}(),ge=new(function(e){function t(t,s){void 0===s&&(s=de.now);var n=e.call(this,t,s)||this;return n.actions=[],n._active=!1,n._scheduled=void 0,n}return S(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var s;this._active=!0;do{if(s=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,s){for(;e=t.shift();)e.unsubscribe();throw s}}},t}(de))(le);class pe{static pretty(e,t=!1){let s=e?JSON.stringify(e,void 0,2):"";if(!t)return s;let n=new RegExp('(\\")(\\w+)(\\")(:)\\s+',"gm");return s=s.replace(n,(function(e,t,s){return'<span##Space##style="color:black;font-weight:bold">'+s+"</span>:&nbsp;&nbsp;"})),s.split("\n").join("<br>").split(" ").join("&nbsp;&nbsp;&nbsp;&nbsp;").split("##Space##").join(" ")}}!function(e){e[e.Verbose=0]="Verbose",e[e.Debug=1]="Debug",e[e.Info=2]="Info",e[e.Warn=3]="Warn",e[e.Error=4]="Error",e[e.Off=5]="Off"}(re||(re={}));class be{}be.channel="#Log",be.logLevel="LogLevel";class me{build(e,t,s,n,i=!1){return this._logLevel=e,this._channel=t,this._object=s,this._caller=n,this._suppress=i,this}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e}get channel(){return this._channel}set channel(e){this._channel=e}get object(){return this._object}set object(e){e.constructor!==String&&(e=pe.pretty(e)),this._object=e}get caller(){return this._caller}set caller(e){this._caller=e}get suppress(){return this._suppress}set suppress(e){this._suppress=e}}class fe{constructor(e,t,s){this.eventBusRef=e,this.monitorChannel=n.stream,this.internalChannelMap=t,this.id=o.genUUID(),this.monitorStream=new ne(this.monitorChannel),this.internalChannelMap.set(this.monitorChannel,this.monitorStream),this.log=s,this.enableMonitorDump(!1),this.monitorBus(),this.channelMap=this.internalChannelMap,this.loggerInstance=this.log}getId(){return this.id}ngZone(){return this._ngZone}getChannel(e,t,s=!1){return this.getChannelObject(e,t,s).stream.pipe(V(e=>(e.payload&&e.payload.hasOwnProperty("sendChannel")&&(e.payload=e.payload.body),e)))}getChannelObject(e,t,s=!1,n=!0){let o,a=!1;return this.internalChannelMap.has(e)?o=this.internalChannelMap.get(e):(o=new ne(e),this.internalChannelMap.set(e,o),a=!0),s||o.increment(),a&&n&&(()=>{let s=(new r).build(i.MonitorNewChannel,e,t,"");this.monitorStream.send((new g).request(s))})(),!s&&n&&(()=>{const s=o.createObserver();let n=(new r).build(i.MonitorObserverJoinedChannel,e,t,{count:o.refCount,id:s,from:t});this.monitorStream.send((new g).request(n))})(),o}getRequestChannel(e,t,s=!1){return this.getChannel(e,t,s).pipe(ie(e=>e.isRequest()))}getResponseChannel(e,t,s=!1){return this.getChannel(e,t,s).pipe(ie(e=>e.isResponse()))}getErrorChannel(e,t,s=!1){return this.getChannel(e,t,s).pipe(ie(e=>e.isError()))}getGalacticChannel(e,t,s,n=!1){return this.getMonitorStream().send((new g).request((new r).build(i.MonitorNewGalacticChannel,e,s,t))),this.getChannelObject(e,s,n).setGalactic().stream.pipe(V(e=>(e.payload.hasOwnProperty("sendChannel")&&(e.payload=e.payload.body),e)))}sendRequest(e,t,s){const n=new d(e,t,!0,e);this.send(n.sendChannel,(new g).request(n),s)}sendResponse(e,t,s){const n=new d(e,t,!0,e);this.send(n.sendChannel,(new g).response(n),s)}complete(e,t){if(!this.internalChannelMap.has(e))return!1;this.monitorStream.send((new g).request((new r).build(i.MonitorCompleteChannel,e,t)));const s=this.internalChannelMap.get(e);return s.complete(),this.destroy(s,t),!0}close(e,t,s="none"){if(!this.internalChannelMap.has(e))return!1;let n=this.internalChannelMap.get(e);n.decrement();let o=(new r).build(i.MonitorObserverLeftChannel,e,t,{count:n.refCount,from:t,id:s});return this.monitorStream.send((new g).request(o)),0===n.refCount?(o=(new r).build(i.MonitorCloseChannel,e,t,n.refCount),this.monitorStream.send((new g).request(o)),this.destroy(n,t),!0):void 0}countListeners(){let e=0;return this.channelMap.forEach(t=>{e+=t.refCount}),e}destroyAllChannels(){this.channelMap.forEach((e,t)=>{this.destroy(e,t)})}refCount(e){return this.internalChannelMap.has(e)?this.internalChannelMap.get(e).refCount:-1}increment(e){return this.channelMap.get(e).increment()}getMonitor(){return this.monitorStream.stream}getMonitorStream(){return this.monitorStream}isLoggingEnabled(){return this.dumpMonitor}enableMonitorDump(e){this.dumpMonitor=e}logger(){return this.log}messageLog(e,t){this.log.info(e,t)}suppressLog(e){this.log.suppress(e)}silenceLog(e){this.log.silent(e)}setLogLevel(e){this.log.logLevel=e}send(e,t,s){t.sender=s;const n=this.internalChannelMap.has(e);let o=(new r).build(n?i.MonitorData:i.MonitorDropped,e,s,t);return n?(this.eventBusRef.zoneRef?this.eventBusRef.zoneRef.runOutsideAngular(()=>{var s;this.internalChannelMap.get(e).send(t),this.monitorStream.send((new g).request(o)),null===(s=this.ngViewRefreshSubject)||void 0===s||s.next()}):(this.monitorStream.send((new g).request(o)),this.internalChannelMap.get(e).send(t)),!0):(this.monitorStream.send((new g).request(o)),!1)}error(e,t){if(!this.internalChannelMap.has(e))return!1;const s=(new r).build(i.MonitorError,e,t);return this.monitorStream.send((new g).error(s)),this.internalChannelMap.get(e).error(t),!0}tickEventLoop(e,t=0){return setTimeout(e,t)}request(e,t,s){const n=this.createMessageHandler(e,!1,t,s);return this.send(e.sendChannel,new g(s).request(e),t),n}respond(e,t){return this.createMessageResponder(e,t)}listen(e,t,s,n){return this.createMessageHandler(e,t,s,n)}setUpNgViewRefreshScheduler(){var e,t;null===(e=this.ngViewRefreshSubscription)||void 0===e||e.unsubscribe(),this._ngZone=this.eventBusRef.zoneRef,this.ngViewRefreshSubject=new p.Subject,this.ngViewRefreshSubscription=this.ngViewRefreshSubject.pipe((void 0===t&&(t=ge),f((function(e,s){var n=null,i=null,r=null,o=function(){if(n){n.unsubscribe(),n=null;var e=i;i=null,s.next(e)}};function a(){var e=r+10,i=t.now();if(i<e)return n=this.schedule(void 0,e-i),void s.add(n);o()}e.subscribe(new j(s,(function(e){i=e,r=t.now(),n||(n=t.schedule(a,10),s.add(n))}),(function(){o(),s.complete()}),void 0,(function(){i=n=null})))})))).subscribe(()=>this.eventBusRef.zoneRef.run(()=>{}))}createMessageResponder(e,t){let s;const n=this.getErrorChannel(e.sendChannel,t,!0),i=this.getRequestChannel(e.sendChannel,t);let r=!1;const o=this.getChannelObject(e.returnChannel,t,!0),a=o.createSubscriber(),c=o.latestObserver,h=()=>{s.unsubscribe(),this.sendUnsubscribedMonitorMessage(a,o.name,t),o.removeSubscriber(a),this.close(e.sendChannel,t,c),s=null,r=!0};return{generate:(r,c)=>{this.sendSubscribedMonitorMessage(a,o.name,t);const l=Object(p.merge)(n,i);return s=l.subscribe(s=>{let n=s.payload;if(s.isError()){let s;s=c||r,this.tickEventLoop(()=>{this.eventBusRef.sendErrorMessage(e.returnChannel,s(n),t)})}else this.tickEventLoop(()=>{this.eventBusRef.sendResponseMessageWithIdAndVersion(e.returnChannel,r(n,{uuid:s.id,version:s.version,from:s.sender}),s.id,s.version,t)});e.singleResponse&&h()},e=>{this.log.error("responder caught error, discarding.",t),s&&h()}),s},tick:t=>{r||this.sendResponse(e.returnChannel,t)},close:()=>(e.singleResponse||(s.unsubscribe(),this.close(e.sendChannel,t,c),this.sendUnsubscribedMonitorMessage(a,o.name,t),r=!0,s=null),!0),isClosed:()=>r,getObservable:()=>Object(p.merge)(i,n).pipe(V(e=>{let t=e.payload;if(e.isError())throw new Error(t);return t}))}}sendSubscribedMonitorMessage(e,t,s){this.monitorStream.send((new g).request((new r).build(i.MonitorObserverSubscribedChannel,t,s,{id:e,from:s})))}sendUnsubscribedMonitorMessage(e,t,s){this.monitorStream.send((new g).request((new r).build(i.MonitorObserverUnsubscribedChannel,t,s,{id:e,from:s})))}createMessageHandler(e,t=!1,s,n){let i;const r=this.getErrorChannel(e.returnChannel,s,!0),o=this.getRequestChannel(e.returnChannel,s,!0),a=this.getResponseChannel(e.returnChannel,s,!0),c=this.getChannel(e.returnChannel,s,!1),l=this.getChannelObject(e.returnChannel,s,!0),u=l.createSubscriber(),d=l.latestObserver;this.sendSubscribedMonitorMessage(u,l.name,s);let g=!1;const b=n,m=()=>{i.unsubscribe(),l.removeSubscriber(u),this.sendUnsubscribedMonitorMessage(u,l.name,s),this.close(e.returnChannel,s,d),i=null,g=!0};return{handle:(n,c)=>{let h;h=t?o:a;const l=Object(p.merge)(r,h);return i=l.subscribe(t=>{let r=!1,o=!0;if(b&&t.id&&(r=!0),r&&t.id&&b!==t.id&&(o=!1),o){let r=t.payload;t.isError()?c&&c(r,{uuid:t.id,version:t.version,from:t.sender}):n?n(r,{uuid:t.id,version:t.version,from:t.sender}):this.log.error("unable to handle response, no handler function supplied",s),e.singleResponse&&i&&m()}else this.log.debug("* Dropping Message "+t.id+", handler only online for "+b,s)},e=>{c?c(e):this.log.error("unable to handle error, no error handler function supplied",s),i&&m()}),i},tick:t=>{g||this.eventBusRef.sendRequestMessageWithId(e.sendChannel,t,n)},error:t=>{i&&!i.closed&&this.eventBusRef.sendErrorMessage(e.returnChannel,t)},close:()=>(e.singleResponse||(i&&m(),i=null),!0),isClosed:()=>g,getObservable(e){let t;switch(e){case h.MessageTypeResponse:t=a;break;case h.MessageTypeError:t=r;break;case h.MessageTypeRequest:t=o;break;default:t=c}return t.pipe(V(e=>{let t=e.payload;if(e.isError())throw new Error(t);return t}))}}}destroy(e,t){this.monitorStream.send((new g).request((new r).build(i.MonitorDestroyChannel,e.name,t))),this.internalChannelMap.delete(e.name)}dumpData(e,t,s=!1){let n=e.data;this.log.group(re.Info,t),n.type===h.MessageTypeRequest?this.log.info(" APIRequest (outbound)",null):n.type===h.MessageTypeError?this.log.info(" ERROR!",null):this.log.info(" APIResponse (inbound)","message type"),this.log.info(" Channel: "+e.channel,null),s&&this.log.warn(" Message Was Dropped!",null),this.log.group(re.Info,n.type===h.MessageTypeError?" Error Payload":" Message Payload"),this.log.info(pe.pretty(n.payload),null),this.log.groupEnd(re.Info),this.log.groupEnd(re.Info)}monitorBus(){this.getMonitor().subscribe(e=>{if(this.dumpMonitor){let t=e.payload,s="Response",n=t.data;if("__maglingtonpuddles__"===t.channel)return;switch(t.type){case i.MonitorNewChannel:this.log.info(" (channel created)-> "+t.channel,t.from);break;case i.MonitorNewGalacticChannel:this.log.info(" (galactic channel mapped)-> "+t.channel,t.from);break;case i.MonitorObserverJoinedChannel:this.log.info(" (new observer "+t.data.id+" ["+t.data.count+"])-> "+t.channel,t.data.from);break;case i.MonitorObserverSubscribedChannel:this.log.info(" (observer subscribed ["+t.data.id+"])-> "+t.channel,t.data.from);break;case i.MonitorObserverUnsubscribedChannel:this.log.info(" (observer un-subscribed ["+t.data.id+"])-> "+t.channel,t.data.from);break;case i.MonitorObserverLeftChannel:this.log.info(" (observer closed ["+t.data.id+"])-> "+t.channel,t.data.from);break;case i.MonitorCloseChannel:this.log.info(" (channel closed)-> "+t.channel,t.from);break;case i.MonitorCompleteChannel:this.log.info(" (channel completed)-> "+t.channel,t.from);break;case i.MonitorDestroyChannel:this.log.info(" (channel destroyed)-> "+t.channel,t.from);break;case i.MonitorData:n.type===h.MessageTypeRequest&&(s="Request"),n.type===h.MessageTypeError&&(s="Error"),this.dumpData(t," ("+s+")-> "+t.channel+" ["+t.from+"]");break;case i.MonitorDropped:this.dumpData(t," (dropped)->  "+t.from+" -> "+t.channel,!0);break;case i.MonitorError:this.log.error("(error)-> "+t.channel,t.from)}}})}}class Ce{constructor(){this._dateCss="color: blue;",this._fromCss="color: green",this._normalCss="color: black;",this._errorCss="color: red;",this._warnCss="color: orange;",this._infoCss="color: brown;",this._debugCss="color: black;",this._verboseCss="color: cyan;",this.dateCssDark="color: #ec96fb;",this.fromCssDark="color: #FF9800;",this.normalCssDark="color: #03a9f4",this.errorCssDark="color: red;",this.warnCssDark="color: orange;",this.infoCssDark="color: #03a9f4",this.debugCssDark="color: #03a9f4",this.verboseCssDark="color: #03a9f4",this._suppress=!1,this._silent=!1,this._styledLogsSupported=!0,this.useDarkThemeFriendlyColors=!0}get dateCss(){return this._dateCss}get fromCss(){return this._fromCss}get normalCss(){return this._normalCss}get errorCss(){return this._errorCss}get warnCss(){return this._warnCss}get infoCss(){return this._infoCss}get debugCss(){return this._debugCss}get verboseCss(){return this._verboseCss}setStylingVisble(e){this._styledLogsSupported=e}useDarkTheme(e){this.useDarkThemeFriendlyColors=e,this.useDarkThemeFriendlyColors&&(this._dateCss=this.dateCssDark,this._fromCss=this.fromCssDark,this._normalCss=this.normalCssDark,this._errorCss=this.errorCssDark,this._warnCss=this.warnCssDark,this._infoCss=this.infoCssDark,this._debugCss=this.debugCssDark,this._verboseCss=this.verboseCssDark)}turnOffAllLogging(){this.silent(!0),this.suppress(!0),this.logLevel=re.Off}turnOnAllLogging(){this.silent(!1),this.suppress(!1),this.logLevel=re.Error}turnOnVerboseLogging(){this.turnOnAllLogging(),this.logLevel=re.Verbose}turnOnDebugLogging(){this.turnOnAllLogging(),this.logLevel=re.Debug}turnOnInfoLogging(){this.turnOnAllLogging(),this.logLevel=re.Info}turnOnWarnLogging(){this.turnOnAllLogging(),this.logLevel=re.Warn}turnOnErrorLogging(){this.turnOnAllLogging(),this.logLevel=re.Error}last(){return this._lastLog}clear(){this._lastLog=""}set logLevel(e){this._logLevel=e}get logLevel(){return this._logLevel}get stylingVisble(){return this._styledLogsSupported}suppress(e){this._suppress=e}silent(e){this._silent=e}verbose(e,t){this.log((new me).build(re.Verbose,be.channel,e,t,this._suppress))}debug(e,t){this.log((new me).build(re.Debug,be.channel,e,t,this._suppress))}info(e,t){this.log((new me).build(re.Info,be.channel,e,t,this._suppress))}warn(e,t){this.log((new me).build(re.Warn,be.channel,e,t,this._suppress))}error(e,t){this.log((new me).build(re.Error,be.channel,e,t,this._suppress))}always(e,t){this.log((new me).build(re.Off,be.channel,e,t))}group(e,t,s=this._suppress){e<this.logLevel||s||console.groupCollapsed(t)}groupEnd(e){e<this.logLevel||this._suppress||console.groupEnd()}outputWithOptionalStyle(e,t,s){let n=[t];this._styledLogsSupported&&(n=n.concat(this.dateCss,this.fromCss,s)),e.apply(console,n)}log(e){if(e.logLevel<this.logLevel)return;if(e.caller?this._lastLog="["+e.caller+"]: "+e.object:this._lastLog=e.object,e.suppress)return;if(this._silent)return;let t=!1;o.isObject(e.object)&&(t=!0);let s=(new Date).toLocaleTimeString(),n="%c"+e.object;switch(e.caller?(n+="%c ["+e.caller+"]%c",n+=" ("+s+")"):n+="%c%c",this._styledLogsSupported||(n=n.replace(/%c/g,"")),e.logLevel){case re.Error:t||(n=" [Error]: "+n),this.outputWithOptionalStyle(console.error,n,this.errorCss);break;case re.Warn:t||(n=" [Warn]: "+n),this.outputWithOptionalStyle(console.warn,n,this.warnCss);break;case re.Info:t||(n=" [Inf]: "+n),this.outputWithOptionalStyle(console.log,n,this.infoCss);break;case re.Debug:t||(n=" [Deb]: "+n),this.outputWithOptionalStyle(console.log,n,this.debugCss);break;case re.Verbose:t||(n=" [Ver]: "+n),this.outputWithOptionalStyle(console.log,n,this.verboseCss)}}}class Se{constructor(e,t,s,n,i){this.value=e,this.successHandler=t,this.errorHandler=s,this.uuid=n,this.stateChangeType=i}}class ye{constructor(e,t){this.changeType=e,this.objectValue=t}get type(){return this.changeType}get value(){return this.objectValue}}class ve extends ye{constructor(e,t,s){super(t,s),this.objectId=e}get id(){return this.objectId}}class _e extends ye{constructor(e,t){super(e,t)}set errorHandler(e){this.pvtErrorHandler=e}get errorHandler(){return this.pvtErrorHandler}set successHandler(e){this.pvtSuccessHandler=e}get successHandler(){return this.pvtSuccessHandler}}class Me{constructor(e,t){this.version=1,this.from="",this.uuid=e,this.stateChangeType=t}}class we{constructor(e,t){this.stream=e,this.log=t}subscribe(e){return this.subscription=this.stream.subscribe(t=>{e?e(t.value,new Me(t.uuid,t.stateChangeType)):this.log.error("unable to handle cache stream event, no handler provided.","StoreStream")}),this.subscription}unsubscribe(){this.subscription&&this.subscription.unsubscribe()}}class Oe extends we{constructor(e,t){super(e,t),this.stream=e}subscribe(e){return this.subscription=this.stream.subscribe(t=>{e?(t.errorHandler&&(this.mutatorErrorHandler=t.errorHandler),t.successHandler&&(this.mutatorSuccessHandler=t.successHandler),e(t.value)):this.log.error("unable to handle cache stream event, no handler provided.","MutateStream")}),this.subscription}error(e){this.mutatorErrorHandler?setTimeout(()=>this.mutatorErrorHandler(e)):this.log.error("unable to send error event back to mutator, no error handler provided.","MutateStream")}success(e){this.mutatorSuccessHandler?setTimeout(()=>this.mutatorSuccessHandler(e)):this.log.error("unable to send success event back to mutator, no success handler provided.","MutateStream")}}class Te{constructor(){this.heartbeatOutgoingInterval=3e4,this.heartbeatIncomingInterval=0}}class ke{constructor(e,t,s=null){this.bus=e,this.type=t,this.galacticStoreSyncChannel=s,this.cacheInitialized=!1,this.isGalactic=!1,this.isGalactic=!!this.galacticStoreSyncChannel,this.cache=new Map,this.uuid=o.genUUID(),this.cacheStreamChan=`stores::store-change-${this.uuid}-${t}`,this.cacheMutationChan=`stores::store-mutation-${this.uuid}-${t}`,this.cacheReadyChan=`stores::store-ready-${this.uuid}-${t}`,this.log=e.api.logger(),this.name=t,this.log.info(` Store: New Store [${t}] was created with id ${this.uuid}, named ${t}`),this.isGalactic&&this.initGalacticStore()}getName(){return"BusStore"}getObjectChannel(e){return"store-"+this.uuid+"-object-"+e}initGalacticStore(){this.syncChannelMessageHandler=this.bus.listenStream(this.galacticStoreSyncChannel,this.getName()),this.syncChannelMessageHandler.handle(e=>{e&&e.storeId===this.type&&("storeContentResponse"===e.responseType?(this.galacticStoreVersion=e.storeVersion,this.cache.clear(),Object.keys(e.items).forEach(t=>this.cache.set(t,e.items[t])),this.initialize()):"updateStoreResponse"===e.responseType&&(e.storeVersion>this.galacticStoreVersion+1&&this.log.warn("Detected missing updates for store: "+this.type),this.galacticStoreVersion=Math.max(this.galacticStoreVersion,e.storeVersion),null===e.newItemValue||void 0===e.newItemValue?this.removeLocal(e.itemId,"galacticSyncRemove"):this.putLocal(e.itemId,e.newItemValue,"galacticSyncUpdate")))}),this.requestStoreContent(),this.connectionMessageHandler=this.bus.listenStream(ee.status),this.connectionMessageHandler.handle(e=>{switch(e.command){case W.STOMP_CONNECTED:this.requestStoreContent()}})}closeStore(){if(this.isGalacticStore()){const e=this.bus.fabric.generateFabricRequest("closeStore",{storeId:this.type});this.bus.sendGalacticMessage(this.galacticStoreSyncChannel,e),this.syncChannelMessageHandler&&this.syncChannelMessageHandler.close(),this.connectionMessageHandler&&this.connectionMessageHandler.close()}}requestStoreContent(){const e=this.bus.fabric.generateFabricRequest("openStore",{storeId:this.type});this.bus.sendGalacticMessage(this.galacticStoreSyncChannel,e)}sendChangeBroadcast(e,t,s){const n=new ve(t,e,s);this.bus.sendResponseMessage(this.cacheStreamChan,n,this.getName()),this.bus.sendResponseMessage(this.getObjectChannel(t),n,this.getName())}allValues(){return Array.from(this.cache.values())}allValuesAsMap(){return new Map(this.cache.entries())}populate(e){return 0===this.cache.size&&!this.isGalacticStore()&&(this.cache=new Map(e.entries()),this.log.info(" Store: Populated with  "+this.cache.size+" values",this.type),this.initialize(),!0)}put(e,t,s){this.isGalacticStore()?this.putGalactic(e,t,s):this.putLocal(e,t,s)}putLocal(e,t,s){this.cache.set(e,t),this.sendChangeBroadcast(s,e,t),this.log.info(" Store: Added new object with id: "+e,this.type)}putGalactic(e,t,s){const n=this.bus.fabric.generateFabricRequest("updateStore",{storeId:this.type,clientStoreVersion:this.galacticStoreVersion,itemId:e,newItemValue:t});this.bus.sendGalacticMessage(this.galacticStoreSyncChannel,n)}remove(e,t){return this.isGalacticStore()?this.removeGalactic(e,t):this.removeLocal(e,t)}removeLocal(e,t){if(this.cache.has(e)){const s=this.cache.get(e);return this.sendChangeBroadcast(t,e,s),this.cache.delete(e),this.bus.api.close(this.getObjectChannel(e),this.getName()),this.log.info(" Store: Removed object with id "+e,this.type),!0}return!1}removeGalactic(e,t){if(this.cache.has(e)){const t=this.bus.fabric.generateFabricRequest("updateStore",{storeId:this.type,clientStoreVersion:this.galacticStoreVersion,itemId:e,newItemValue:null});return this.bus.sendGalacticMessage(this.galacticStoreSyncChannel,t),!0}return!1}get(e){return this.cache.get(e)}isGalacticStore(){return this.isGalactic}onChange(e,...t){const s=this.bus.api.getResponseChannel(this.getObjectChannel(e),this.getName()),n=this.bus.api.getErrorChannel(this.getObjectChannel(e),this.getName()),i=Object(p.merge)(s,n).pipe(V(e=>e.payload));return new we(this.filterStream(i,[e=>!(t&&t.length>0)||t.indexOf(e.type)>=0]),this.log)}onAllChanges(...e){const t=this.bus.api.getResponseChannel(this.cacheStreamChan,this.getName()),s=this.bus.api.getErrorChannel(this.cacheStreamChan,this.getName()),n=Object(p.merge)(t,s).pipe(V(e=>e.payload));return new we(this.filterStream(n,[t=>!(e&&e.length>0)||e.indexOf(t.type)>=0]),this.log)}filterStream(e,t){return t.forEach(t=>{e=e.pipe(ie(t))}),e.pipe(V(e=>new Se(e.value,null,null,e.id,e.type)))}mutate(e,t,s,n){const i=new _e(t,e);return i.errorHandler=n,i.successHandler=s,this.bus.sendRequestMessage(this.cacheMutationChan,i,this.getName()),this.log.debug(" Store: Fired mutation command",this.type),!0}onMutationRequest(e,...t){const s=this.bus.api.getChannel(this.cacheMutationChan,this.getName()).pipe(V(e=>e.payload)).pipe(ie(e=>!(t&&t.length>0)||t.indexOf(e.type)>=0),V(e=>new Se(e.value,e.successHandler,e.errorHandler)));return new Oe(s,this.log)}reset(){this.cache.clear(),this.cacheInitialized=!1,this.log.warn(` Store: [${this.name}] (${this.uuid}) has been reset. All data wiped `,this.name),this.isGalacticStore()&&this.requestStoreContent()}whenReady(e){this.bus.listenOnce(this.cacheReadyChan).handle(e),setTimeout(()=>{this.cacheInitialized&&(this.log.debug(` Store: [${this.name}] (${this.uuid}) Ready! Contains ${this.allValuesAsMap().size} values`,this.name),this.bus.sendResponseMessage(this.cacheReadyChan,this.allValuesAsMap()))})}initialize(){this.cacheInitialized||(this.cacheInitialized=!0,this.log.info(" Store: ["+this.type+"] Initialized!",this.type),this.bus.sendResponseMessage(this.cacheReadyChan,this.allValuesAsMap()))}startAutoReload(e=1e4){this.isGalacticStore()?this.log.warn("Called startAutoReload() API on galactic store: "+this.type):(this.reloadTTL=e,this.stopAutoReload(),e>0&&this.reloadHandler&&(this.reloadIntervalTracker=setInterval(()=>{this.reloadHandler()},e)))}stopAutoReload(){this.isGalacticStore()?this.log.warn("Called stopAutoReload() API on galactic store: "+this.type):this.reloadIntervalTracker&&clearInterval(this.reloadIntervalTracker)}refreshApiDelay(){this.isGalacticStore()?this.log.warn("Called refreshApiDelay() API on galactic store: "+this.type):(this.stopAutoReload(),this.reloadHandler?this.reloadIntervalTracker=setInterval(()=>{this.reloadHandler()},this.reloadTTL):this.log.warn(`Unable to refresh API delay for ${this.name}, no reloadHandler has been defined.`,this.getName()))}reloadStore(){this.isGalacticStore()?this.log.warn("Called reloadStore() API on galactic store: "+this.type):(this.refreshApiDelay(),this.reloadHandler?this.reloadHandler():this.log.warn(`Unable to reload store ${this.name}, no reloadHandler has been defined.`,this.getName()))}setAutoReloadServiceTrigger(e){this.isGalacticStore()?this.log.warn("Called setAutoReloadServiceTrigger() API on galactic store: "+this.type):this.reloadHandler=e}}class Ee{constructor(e){this.bus=e,this.internalStoreMap=new Map}openGalacticStore(e,t){if(this.initGalacticStoreSyncChannel(t),this.getStore(e)){const t=this.getStore(e);return t.isGalacticStore()||this.bus.logger.error("openGalacticStore() called with already existing local store!"),this.bus.logger.verbose(`Stores: Returning reference to ${e} as it already exists`),t}{this.bus.logger.verbose(`Store: Opening galactic store ${e} as it does not exist!`);const t=new ke(this.bus,e,this.galacticStoreSyncChannel);return this.internalStoreMap.set(e,t),t}}createStore(e,t){if(this.getStore(e)){const t=this.getStore(e);return t.isGalacticStore()&&this.bus.logger.error("createStore() called with already existing galactic store!"),this.bus.logger.verbose(`Stores: Returning reference to ${e} as it already exists`),t}{this.bus.logger.verbose(`Store: Creating store ${e} as it does not exist!`);const s=new ke(this.bus,e);return t&&s.populate(t),this.internalStoreMap.set(e,s),s}}getStore(e){return this.internalStoreMap.get(e)}getAllStores(){return Array.from(this.internalStoreMap.values())}wipeAllStores(){this.internalStoreMap.forEach(e=>{e.reset()}),this.bus.logger.warn(" Stores: All data has been wiped out and reset.","StoreManager")}destroyStore(e){return!!this.internalStoreMap.has(e)&&(this.internalStoreMap.get(e).closeStore(),this.internalStoreMap.delete(e),!0)}readyJoin(e){return{whenReady:t=>{let s=0;for(let n of e)this.createStore(n).whenReady(()=>{s++,s===e.length&&t(Array.from(this.internalStoreMap.values()))})}}}initGalacticStoreSyncChannel(e){this.galacticStoreSyncChannel||(this.galacticStoreSyncChannel="fabric-store-sync."+Date.now().toString(32)+"-"+o.genUUID(),this.bus.markChannelAsGalactic(this.galacticStoreSyncChannel,e))}}class Re{constructor(e,t,s){this.channel=e,this.id=b.genUUID(),this.payload=t,this.complete=!1,this.aborted=!1,this.store=s}}class Ie{constructor(e,t){this.totalRequests=e,this.requestsSent=0,this.requestsCompleted=0,this.aborted=!1,this.complete=!1,this.id=t}}class Ne{constructor(e,t,s=l.ASYNC,n="BusTransaction"){this.completed=!1,this.transactionCompleteError=null,this.bus=e,this.log=t,this.transactionType=s,this.requests=[],this.name=n,this.id=o.genUUID(),this.transactionErrorChannel="transaction-"+this.id+"-errors",this.log.info(" Transaction Created",this.transactionName())}waitForStoreReady(e){if(this.completed)throw this.transactionCompletedMessage("cannot queue a new cache initialization via waitForCacheReady()"),this.transactionCompleteError;const t=new Re(null,null,e);this.requests.push(t),this.log.debug(" Transaction: Store Request Queued: ["+t.id+"]",this.transactionName())}sendRequest(e,t){if(this.completed)throw this.transactionCompletedMessage("cannot queue a new request via sendRequest()"),this.transactionCompleteError;const s=new Re(e,t);this.requests.push(s),this.log.debug(" Transaction: Bus Request Queued: ["+s.id+"]",this.transactionName())}onComplete(e){if(this.completed)throw this.transactionCompletedMessage("cannot register onComplete() handler"),this.transactionCompleteError;this.log.debug(" Transaction: Completed Handler Registered",this.transactionName()),this.completedHandler=e}commit(){if(this.completed)throw this.transactionCompletedMessage("cannot re-commit transaction via commit()"),this.transactionCompleteError;if(this.requests.length<=0)throw new Error("Transaction cannot be committed, no requests made.");switch(this.transactionReceipt=new Ie(this.requests.length,this.id),this.transactionType){case l.ASYNC:this.startAsyncTransaction();break;case l.SYNC:this.startSyncTransaction()}return this.transactionReceipt}onError(e){if(this.completed)throw this.transactionCompletedMessage("cannot register new error handler via onError()"),this.transactionCompleteError;this.bus.listenOnce(this.transactionErrorChannel).handle(t=>{this.log.error("Transaction ["+this.id+"]",t),this.transactionErrored(),e(t)})}sendRequestAndListen(e,t,s){this.log.debug(" Transaction: Sending "+s+" Request to channel: "+e.channel,this.transactionName());const n=e.payload&&e.payload.id?e.payload.id:o.genUUID(),i=this.bus.listenStream(e.channel,this.name,n);let r=0;i.handle(n=>{r++,this.log.debug(" Transaction: Received "+s+" Response on channel: "+e.channel+" - "+n,this.transactionName()),t(n),r>=this.getExpectedHandlerCalls(e)&&i.close()},(t,s)=>{r++,this.bus.sendResponseMessageWithId(this.transactionErrorChannel,t,n),r>=this.getExpectedHandlerCalls(e)&&i.close()}),this.bus.sendRequestMessageWithId(e.channel,e.payload,n)}transactionErrored(){this.bus.closeChannel(this.transactionErrorChannel),this.transactionReceipt.complete=!0,this.transactionReceipt.completedTime=new Date,this.transactionCompleted()}transactionCompleteHandler(e){this.transactionReceipt.complete=!0,this.transactionReceipt.completedTime=new Date,this.transactionCompleted(),this.completedHandler(e)}startAsyncTransaction(){this.log.info(" Transaction: Starting Asynchronous",this.transactionName());let e=new Array;const t=this.requests.slice();let s=0;const n=n=>{s++,e.push(n);const i=t.map(e=>this.getExpectedHandlerCalls(e)).reduce((e,t)=>e+t);this.transactionReceipt.requestsCompleted++,s>=i&&this.transactionCompleteHandler(e)};this.transactionReceipt.startedTime=new Date,t.forEach(e=>{this.transactionReceipt.requestsSent++,e.store?(this.log.info(" Transaction: Waiting for Store: "+e.store,this.transactionName()),this.bus.stores.createStore(e.store).whenReady(n)):this.sendRequestAndListen(e,n,l.ASYNC)})}transactionName(){return this.name+"."+this.id}startSyncTransaction(){this.syncStream=new p.Subject,this.log.info(" Transaction: Starting Synchronous",this.transactionName());let e=new Array;const t=this.requests.slice();let s=0;for(let e=0;e<t.length;e++)e>=0&&e<t.length&&(t[e].nextRequest=t[e+1]);this.syncStream.subscribe(n=>{const i=i=>{s++,e.push(i),this.transactionReceipt.requestsCompleted++;const r=t.map(e=>this.getExpectedHandlerCalls(e)).reduce((e,t)=>e+t);n.nextRequest&&this.syncStream.next(n.nextRequest),s>=r&&this.syncStream.complete()};this.transactionReceipt.requestsSent++,n.store?(this.log.info(" Transaction: Waiting for Store: "+n.store,this.transactionName()),this.bus.stores.createStore(n.store).whenReady(i)):this.sendRequestAndListen(n,i,l.ASYNC)},()=>null,()=>{this.transactionCompleteHandler(e)}),this.syncStream.next(t[0])}transactionCompleted(){this.completed=!0,this.transactionCompleteError=new Error("transaction "+this.id+" has already completed"),this.log.info(" Transaction Completed",this.transactionName())}transactionCompletedMessage(e){this.log.warn("Transaction Complete: "+e,this.transactionName())}getExpectedHandlerCalls(e){const t=this.bus.brokerConnector.galacticChannels.get(e.channel);return this.bus.brokerConnector.galacticChannels.has(e.channel)&&t.connectedBrokers>0?t.connectedBrokers:1}}window,function(e){e.RegisterEventBus="Registration",e.BusStopListening="Stop Listening",e.BusStartListening="Start Listening"}(oe||(oe={}));class Pe{constructor(e,t,s,n){this.control=null,this.payload=e,this.channel=t,this.type=s,this.from=n}}!function(e){e.Parent="parent",e.Child="child",e.Hybrid="hybrid"}(ae||(ae={}));const De=window;class Ae{constructor(e,t){this.bus=e,this.config=t,this.proxyControlChannel="__proxycontrol__",this.proxyId=u.id,this.devMode=!1,this.registered=!1,this.targetAllFramesValue=!0,this.listening=!1,this.authorizedChannels=[],this.authorizedChannels.push(this.proxyControlChannel),this.targetOrigin=["*"],t?(t.acceptedOrigins&&(this.targetOrigin=t.acceptedOrigins),t.targetAllFrames||this.targetAllFrames(!1),t.targetSpecificFrames&&t.targetSpecificFrames.length>0?this.targetedFrames=t.targetSpecificFrames:this.targetedFrames=[],t.protectedChannels&&t.protectedChannels.length>0&&(this.authorizedChannels=this.authorizedChannels.concat(t.protectedChannels)),t.parentOrigin?this.parentOriginValue=t.parentOrigin:this.parentOriginValue="*",t.proxyType&&(this.proxyType=t.proxyType),this.monitorChannel=this.bus.api.getChannel(n.stream),this.knownBusInstances=new Map,this.listen()):this.bus.logger.error("Message Proxy cannot start. No configuration has been set.",this.getName())}listen(){if(!this.listening)switch(this.listening=!0,this.postMessageEventHandlerBinding=this.parentEventHandler.bind(this),this.config.proxyType){case ae.Parent:this.listenForInboundMessageEvents(),this.relayMessagesToChildren();break;case ae.Child:this.listenForInboundMessageEvents(),this.registered?this.informParentChildBusIsListening():this.registerChildBusWithParent(),this.relayMessagesToParent();break;case ae.Hybrid:}}registerChildBusWithParent(){const e={command:oe.RegisterEventBus,body:u.id,proxyType:this.proxyType};this.sendControlToParent(e),this.registered=!0}informParentChildBusIsListening(){const e={command:oe.BusStartListening,body:u.id,proxyType:this.proxyType};this.sendControlToParent(e)}informParentChildBusStoppedListening(){const e={command:oe.BusStopListening,body:u.id,proxyType:this.proxyType};this.sendControlToParent(e)}listenForInboundMessageEvents(){this.registered||De.addEventListener("message",this.postMessageEventHandlerBinding,!0)}relayMessagesToChildren(){this.monitorSubscription=this.monitorChannel.subscribe(e=>{let t=e.payload;switch(t.type){case i.MonitorData:for(let e of this.authorizedChannels)t.channel===e&&this.sendMessageToChildFrames(t.data,e)}})}relayMessagesToParent(){this.monitorSubscription=this.monitorChannel.subscribe(e=>{let t=e.payload;switch(t.type){case i.MonitorData:for(let s of this.authorizedChannels)t.channel!==s||t.data.proxyRebroadcast||e.sender!==u.id&&this.sendMessageToParent(t.data,s)}})}sendMessageToParent(e,t){this.bus.logger.debug(`Authorized message received on: [${t}], sending to parent frame`,this.getName());const s=new Pe(JSON.stringify(e),t,e.type,u.id);parent.window.postMessage(s,"*")}sendControlToParent(e){this.bus.logger.debug(`Authorized control message command: '${e.command}' received, sending to parent frame`,this.getName());const t=new Pe(JSON.stringify(e),this.proxyControlChannel,h.MessageTypeControl,u.id);t.control=e.command,parent.window.postMessage(t,"*")}sendMessageToChildFrames(e,t){this.bus.logger.debug(`Authorized message received on: [${t}], from ${e.sender}, sending to children`,this.getName());const s=new Pe(JSON.stringify(e),t,e.type,e.sender);if(this.targetAllFramesValue){const e=De.frames,t=De.frames.length;if(t>0)for(let n=0;n<t;n++)e[n].postMessage(s,"*")}if(this.targetedFrames.length>0)for(let e of this.targetedFrames){const t=De.document.getElementById(e).contentWindow;t&&t.postMessage(s,"*")}}parentEventHandler(e){if(this.listening&&(this.devMode||!e.data||!e.data.from||e.data.from!==u.id))if(this.targetOrigin.indexOf(e.origin)>=0)if(e.data&&""!==e.data){const t=e.data;if(!(t.hasOwnProperty("channel")&&t.hasOwnProperty("type")&&t.hasOwnProperty("payload")))return this.bus.logger.debug("Message Ignored, not intended for the bus.",this.getName()),this.bus.logger.group(re.Info," Message Payload (Ignored)"),this.bus.logger.debug(pe.pretty(t)),void this.bus.logger.groupEnd(re.Info);if(null===t.channel||""===t.channel)return void this.bus.logger.warn("Proxy Message invalid - ignored. No channel supplied",this.getName());if(null===t.type||""===t.type)return void this.bus.logger.warn("Proxy Message invalid - ignored. No message type supplied",this.getName());if(null===t.payload||""===t.payload)return void this.bus.logger.warn("Proxy Message invalid - ignored. Payload is empty",this.getName());if(!this.validateChannel(t.channel))return void this.bus.logger.warn("Proxy Message valid, but channel is not authorized: ["+t.channel+"]",this.getName());{let e;try{e=JSON.parse(t.payload),t.payload=e}catch(s){e=t.payload}if(null!=t.control){let s,n;switch(t.control){case oe.RegisterEventBus:this.knownBusInstances.has(e.body)||(this.knownBusInstances.set(e.body,{type:e.proxyType,active:!0}),this.bus.logger.info("Child Event Bus Registered: "+e.body,this.getName()),n=(new r).build(i.MonitorChildProxyRegistered,this.proxyControlChannel,e.body,e.body),this.bus.api.getMonitorStream().send((new g).response(n)));break;case oe.BusStartListening:s=this.knownBusInstances.get(e.body),s&&(s.active=!0),this.knownBusInstances.set(e.body,s),n=(new r).build(i.MonitorChildProxyListening,this.proxyControlChannel,e.body,e.body),this.bus.api.getMonitorStream().send((new g).response(n));break;case oe.BusStopListening:s=this.knownBusInstances.get(e.body),s&&(s.active=!1),this.knownBusInstances.set(e.body,s),this.listening=!1,n=(new r).build(i.MonitorChildProxyNotListening,this.proxyControlChannel,e.body,e.body),this.bus.api.getMonitorStream().send((new g).response(n))}}else this.proxyMessage(t)}}else this.bus.logger.debug("Message Ignored, it contains no payload",this.getName());else this.bus.logger.warn(`Event bus broadcast refused by bus ${u.id}, origin not registered: ${e.origin}`,this.getName())}validateChannel(e){return this.authorizedChannels.includes(e)}proxyMessage(e){let t=e.payload;switch(t.proxyRebroadcast=!0,e.type){case h.MessageTypeRequest:this.bus.sendRequestMessageWithId(e.channel,t.payload,t.id,e.from,!0);break;case h.MessageTypeResponse:this.bus.sendResponseMessageWithId(e.channel,t.payload,t.id,e.from,!0);break;case h.MessageTypeError:this.bus.sendErrorMessage(e.channel,t.payload,e.from,!0)}}listeningAs(){return this.proxyType}stopListening(){this.listening&&(this.monitorSubscription.unsubscribe(),this.informParentChildBusStoppedListening(),De.removeEventListener("message",this.postMessageEventHandlerBinding,!0))}targetAllFrames(e){(!this.targetedFrames||this.targetedFrames.length<=0)&&(this.targetAllFramesValue=e)}isTargetingAllFrames(){return this.targetAllFramesValue}addAllowedTargetOrigin(e){this.targetOrigin.indexOf(e)<0&&this.targetOrigin.push(e)}addTargetedFrame(e){this.targetedFrames.indexOf(e)<0&&this.targetedFrames.push(e)}addAuthorizedChannel(e){this.authorizedChannels.indexOf(e)<0&&this.authorizedChannels.push(e)}removeAllowedTargetOrigin(e){const t=this.targetOrigin.indexOf(e);t>=0&&this.targetOrigin.splice(t,1)}removeAuthorizedChannel(e){const t=this.authorizedChannels.indexOf(e);t>=0&&this.authorizedChannels.splice(t,1)}removeTargetedFrame(e){const t=this.targetedFrames.indexOf(e);t>=0&&this.targetedFrames.splice(t,1)}getAuthorizedChannels(){let e=this.authorizedChannels;return this.authorizedChannels.indexOf(this.proxyControlChannel)>=0&&e.splice(0,1),e}getAllowedOrigins(){return this.targetOrigin}getTargetedFrames(){return this.targetedFrames}isListening(){return this.listening}getParentOrigin(){return this.parentOriginValue}setParentOrigin(e){this.parentOriginValue=e}getKnownBusInstances(){return new Map(this.knownBusInstances.entries())}inDevMode(){return this.devMode}getName(){return this.proxyId}setDevMode(){this.devMode=!0}}class Be{constructor(e){this.bus=e}enableProxy(e){return this.proxyControl||(this.proxyControl=new Ae(this.bus,e)),this.proxyControl}}class xe extends u{constructor(e=re.Off,t=!0,s=!1){super(),this.windowRef=window,this.devModeEnabled=!1,this.internalChannelMap=new Map,this.log=new Ce,s&&this.log.useDarkTheme(!0),this.api=new fe(this,this.internalChannelMap,this.log),this.stores=new Ee(this),this.brokerConnector=new X(this.log),this.windowRef.AppEventBus=this,this.windowRef.AppBrokerConnector=this.brokerConnector,this.windowRef.AppBrokerConnector.init(this),this.windowRef.window.AppSyslog=this.log,this.windowRef.AppStoreManager=this.stores,t||(this.log.setStylingVisble(!0),this.log.info(` VMware Transport v${u.version} Initialized with Id: ${u.id}, Hi!`,"EventBus")),this.log.logLevel=e,this.api.setLogLevel(e),this.fabric=new Z(this)}static destroy(){this.instance.destroy(),this.instance=null}static getInstance(){return xe.boot()}static boot(){return this.instance||(this.instance=new this)}static bootWithOptions(e,t,s=!1){return this.instance||(this.instance=new this(e,t,s))}static rebootWithOptions(e,t){return this.instance=new this(e,t,!1),this.instance}static reboot(){return this.instance=new this}get logger(){return this.log}getName(){return"EventBus"}setNgZoneRef(e){this.zoneRef=e,this.api.setUpNgViewRefreshScheduler()}destroy(){var e;null===(e=this.api.ngViewRefreshSubscription)||void 0===e||e.unsubscribe()}enableDevMode(){this.devModeEnabled=!0,this.log.warn("Dev Mode Enabled on Event Bus, This should never be enabled in production")}enableMessageProxy(e){return this.messageProxy=new Be(this),this.proxyControl=this.messageProxy.enableProxy(e),this.proxyControl}connectBridge(e,t,s,n,i=1,r,a,c,h,l,u,d=!0,g){const p=se.generate(t,r,a,u,h,l,c);p.topicLocation=s,p.queueLocation=n,p.brokerConnectCount=i,p.autoReconnect=d,p.getAccessTokenFunction=this.fabric.getAccessToken.bind(this.fabric),p.accessTokenHeaderKey=this.fabric.accessTokenHeaderKey,p.sendAccessTokenDuringHandshake=this.fabric.sendAccessTokenDuringHandshake,p.protocols=this.fabric.protocols?this.fabric.protocols.slice():void 0,g&&(p.heartbeatIn=g.heartbeatIncomingInterval,p.heartbeatOut=g.heartbeatOutgoingInterval,p.startIntervalFunction=g.startIntervalFunction),this.devModeEnabled&&(p.testMode=!0);const m=this.requestStreamWithId(o.getFabricConnectionString(p.host,p.port,p.endpoint),ee.connection,b.generateStompBusCommand(W.STOMP_CONNECT,"","",p));return m.handle(t=>{t.command===W.STOMP_CONNECTED?(e(t.session),m.close()):this.api.logger().info("connection handler received command message: "+t.command,this.getName())}),m}listenGalacticStream(e,t=this.getName(),s){return this.internalChannelMap.has(e)||this.api.getGalacticChannel(e,s,t,!1),this.listenStream(e,t)}isGalacticChannel(e){return!!this.internalChannelMap.has(e)&&this.internalChannelMap.get(e).galactic}closeGalacticChannel(e,t,s){this.api.getMonitorStream().send((new g).request((new r).build(i.MonitorGalacticUnsubscribe,e,t,s)))}sendGalacticMessage(e,t,s){this.api.getMonitorStream().send((new g).request((new r).build(i.MonitorGalacticData,e,s,t)))}sendRequestMessage(e,t,s=this.getName()){this.api.send(e,(new g).request(t),s)}sendRequestMessageWithId(e,t,s,n,i=!1){this.api.send(e,new g(s,1,i).request(t),n)}sendRequestMessageWithIdAndVersion(e,t,s,n,i,r=!1){this.api.send(e,new g(s,n,r).request(t),i)}sendResponseMessage(e,t,s=this.getName()){return this.api.send(e,(new g).response(t),s),!0}sendResponseMessageWithId(e,t,s,n,i=!1){this.api.send(e,new g(s,1,i).response(t),n)}sendResponseMessageWithIdAndVersion(e,t,s,n,i,r=!1){this.api.send(e,new g(s,n,r).response(t),i)}sendErrorMessageWithId(e,t,s,n,i){this.api.send(e,new g(s,1,i).error(t),n)}sendErrorMessageWithIdAndVersion(e,t,s,n,i,r){this.api.send(e,new g(s,n,r).error(t),i)}sendErrorMessage(e,t,s=this.getName(),n=!1){this.api.send(e,new g(o.genUUID(),1,n).error(t),s)}respondOnce(e,t,s=this.getName()){return this.api.respond(new d(e,null,!0,t),s)}respondStream(e,t,s=this.getName()){return this.api.respond(new d(e,null,!1,t),s)}requestStream(e,t,s,n=this.getName()){return this.api.request(new d(e,t,!1,s),n)}requestStreamWithId(e,t,s,n,i=this.getName()){return this.api.request(new d(t,s,!1,n),i,e)}requestOnce(e,t,s,n=this.getName()){return this.api.request(new d(e,t,!0,s),n)}requestOnceWithId(e,t,s,n,i){return this.api.request(new d(t,s,!0,n),i,e)}listenOnce(e,t=this.getName(),s){return this.api.listen(new d(e,null,!0,e),!1,t)}listenStream(e,t=this.getName(),s){return this.api.listen(new d(e,null,!1,e),!1,t,s)}listenRequestOnce(e,t=this.getName(),s){return this.api.listen(new d(e,null,!0,e),!0,t,s)}listenRequestStream(e,t=this.getName(),s){return this.api.listen(new d(e,null,!1,e),!0,t,s)}closeChannel(e,t){return this.api.close(e,t)}createTransaction(e=l.ASYNC,t="Transaction"+o.genUUID()){return new Ne(this,this.log,e,t)}easterEgg(){this.api.getRequestChannel("__maglingtonpuddles__",this.getName(),!0).subscribe(()=>{this.sendResponseMessage("__maglingtonpuddles__","Maggie wags his little nubby tail at you, as he sits under his little yellow boat on the beach")})}markChannelsAsGalactic(e){for(const t of e)this.markChannelAsGalactic(t)}markChannelAsGalactic(e,t,s){const n=this.api.getChannelObject(e);n.setGalactic(),!0===s?n.setPrivate():n.setPublic(),this.api.getMonitorStream().send((new g).request((new r).build(i.MonitorNewGalacticChannel,e,this.getName(),{isPrivate:n.isPrivate,brokerIdentity:t})))}markChannelsAsLocal(e){for(const t of e)this.markChannelAsLocal(t)}markChannelAsLocal(e,t){const s=this.api.getChannelObject(e);s.setLocal(),this.api.getMonitorStream().send((new g).request((new r).build(i.MonitorGalacticUnsubscribe,e,this.getName(),{isPrivate:s.isPrivate,brokerIdentity:t})))}}}])},"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rxjs")):"function"==typeof define&&define.amd?define(["rxjs"],t):"object"==typeof exports?exports.transport=t(require("rxjs")):e.transport=t(e.rxjs);